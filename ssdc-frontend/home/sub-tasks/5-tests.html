<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tests</title>
<link href="../../vendor/fonts/fonts.css" rel="stylesheet">
<link href="../../vendor/boxicons/css/boxicons.min.css" rel="stylesheet">

<style>
:root{
  --bg:#f6f1e7;
  --bg-soft:#fffaf2;
  --ink:#1e262d;
  --muted:#6b737c;
  --accent:#0f766e;
  --accent-strong:#0b5f58;
  --warm:#e08f2f;
  --danger:#c0392b;
  --line:#e3d9c9;
  --shadow:0 18px 40px rgba(28, 41, 61, 0.12);
  --radius-lg:22px;
  --radius-md:14px;
  --radius-sm:10px;
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:24px;
  font-family:"Poppins","Lato",sans-serif;
  background:
    radial-gradient(circle at 12% 8%, #ffffff 0%, #f8f3ea 40%, #f2ede2 100%),
    linear-gradient(135deg, #f2ede2 0%, #f9f5ee 100%);
  color:var(--ink);
  min-height:100vh;
}
.page{
  max-width:1200px;
  margin:0 auto;
  display:grid;
  gap:18px;
}
.head-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:18px;
  animation:fadeUp .45s ease both;
}
.head-title h1{
  font-size:32px;
  font-weight:700;
  margin:0;
  letter-spacing:.3px;
}
.subtitle{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.header-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:flex-end;
}
.neo-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:999px;
  background:linear-gradient(135deg, var(--accent), #1aa191);
  color:#fff;
  box-shadow:0 12px 24px rgba(15, 118, 110, 0.18);
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}
.neo-btn:hover{transform:translateY(-1px)}
.neo-btn:active{transform:translateY(1px)}
.neo-btn.secondary{
  background:var(--bg-soft);
  color:var(--ink);
  border:1px solid var(--line);
  box-shadow:none;
}
.tabs{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  animation:fadeUp .5s ease both;
}
.tabs button{
  padding:8px 18px;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--bg-soft);
  color:var(--muted);
  font-weight:600;
  cursor:pointer;
}
.tabs .active{
  color:#fff;
  background:linear-gradient(135deg, var(--accent), #1aa191);
  border-color:transparent;
  box-shadow:0 10px 22px rgba(15, 118, 110, 0.2);
}
.neo{
  background:var(--bg-soft);
  border:1px solid var(--line);
  border-radius:var(--radius-md);
  box-shadow:var(--shadow);
}
.table-box{
  border-radius:var(--radius-lg);
  background:var(--bg-soft);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  padding:16px;
  animation:fadeUp .55s ease both;
}
.table-wrap{overflow-x:auto}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 10px;
  table-layout:fixed;
  min-width:980px;
}
thead th{
  text-align:left;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.6px;
  color:var(--muted);
  padding:0 12px 6px;
}
tbody tr{
  background:#fff;
  transition:transform .15s ease, box-shadow .15s ease;
}
tbody tr:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(20, 30, 45, 0.1);
}
body.menu-open tbody tr:hover{
  transform:none;
  box-shadow:none;
}
tbody tr.menu-open{
  position:relative;
  z-index:2;
}
tbody td{
  padding:12px;
  border-top:1px solid var(--line);
  border-bottom:1px solid var(--line);
}
tbody td:first-child{
  border-left:1px solid var(--line);
  border-radius:12px 0 0 12px;
}
tbody td:last-child{
  border-right:1px solid var(--line);
  border-radius:0 12px 12px 0;
}
.sno{width:60px}
.name{width:220px; overflow-wrap:anywhere}
.category{width:140px; text-transform:uppercase; font-size:12px; color:var(--muted)}
.shortcut{width:110px; white-space:nowrap}
.normal{width:260px; font-size:12px; white-space:pre-line; color:var(--muted)}
.cost{width:110px; text-align:right; font-weight:600; white-space:nowrap}
.active-col{width:110px}
.options{width:90px}
.menu{position:relative; display:inline-flex; justify-content:center; width:100%}
.menu-btn{
  cursor:pointer;
  font-size:18px;
  line-height:1;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--bg-soft);
}
.menu-list{
  display:none;
  position:absolute;
  right:0;
  top:32px;
  background:#fff;
  border-radius:14px;
  border:1px solid var(--line);
  box-shadow:0 12px 24px rgba(20, 30, 45, 0.12);
  z-index:30;
  min-width:140px;
  overflow:hidden;
}
.menu-list div{
  padding:10px 16px;
  cursor:pointer;
  font-size:13px;
}
.menu-list div:hover{background:#f6f1e7}
.menu-list .danger{color:var(--danger)}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(26, 26, 26, 0.4);
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:20;
  backdrop-filter:blur(4px);
}
.modal-card{
  width:560px;
  max-height:85vh;
  overflow:auto;
  padding:22px;
  border-radius:22px;
  background:var(--bg-soft);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
}
.modal-card h3{margin:0 0 12px}
.modal-card h4{margin:16px 0 8px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px}
.modal-card input,
.modal-card textarea{
  width:100%;
  padding:10px 12px;
  margin-bottom:10px;
  border:1px solid var(--line);
  border-radius:var(--radius-md);
  background:#fff;
  font-size:14px;
}
.modal-card textarea{min-height:80px; resize:vertical}
.inline{display:flex;gap:8px;align-items:center}
.actions{display:flex;gap:10px;flex-wrap:wrap}

.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 24px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d4c9b7;
  transition: 0.3s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: var(--accent);
}
input:checked + .slider:before {
  transform: translateX(22px);
}

@keyframes fadeUp{
  from{opacity:0; transform:translateY(8px)}
  to{opacity:1; transform:translateY(0)}
}
@media (max-width:900px){
  body{padding:16px}
  .head-title{flex-direction:column; align-items:flex-start}
  .header-actions{width:100%; justify-content:flex-start}
}
@media (max-width:600px){
  .head-title h1{font-size:28px}
}
</style>
  <link rel="stylesheet" href="theme.css">
</head>

<body>

<div class="page">
  <div class="head-title">
    <div>
      <h1>Tests</h1>
      <div class="subtitle">Create tests, groups, and manage availability</div>
    </div>
    <div class="header-actions">
      <button class="neo-btn secondary" onclick="location.href='test/arrange-tests.html'">
        <i class="bx bx-grid-alt"></i> Arrange Tests
      </button>
      <button class="neo-btn secondary" onclick="location.href='test/new-group.html'">
        <i class="bx bx-layer-plus"></i> New Group
      </button>
      <button class="neo-btn" onclick="location.href='test/new-tests.html'">
        <i class="bx bx-plus"></i> New Test
      </button>
    </div>
  </div>

  <div class="tabs">
    <button class="active" onclick="setMode('all',this)">All</button>
    <button onclick="setMode('single',this)">Single</button>
    <button onclick="setMode('group',this)">Group</button>
  </div>

  <div class="table-box">
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th class="sno">S.No</th>
          <th class="name">Name</th>
          <th class="category">Category</th>
          <th class="shortcut">Shortcut</th>
          <th class="normal">Normal Values</th>
          <th class="cost">Cost</th>
          <th class="active-col">Active</th>
          <th class="options">Option</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== SINGLE TEST EDIT MODAL ===== -->
<div class="modal" id="testModal">
  <div class="modal-card">
    <h3>Edit Test</h3>

    <input id="tName" placeholder="Test Name">
    <input id="tShortcut" placeholder="Shortcut">
    <input id="tCategory" placeholder="Category">
    <input id="tCost" type="number" placeholder="Cost">

    <h4>Normal Values</h4>
    <div id="nBox"></div>
    <button class="neo-btn secondary" onclick="addNormal()">+ Normal</button>

    <div class="actions">
      <button class="neo-btn" onclick="saveTest()">Save</button>
      <button class="neo-btn secondary" onclick="closeTest()">Cancel</button>
    </div>
  </div>
</div>

<!-- ===== GROUP EDIT MODAL ===== -->
<div class="modal" id="groupModal">
  <div class="modal-card">
    <h3>Edit Group</h3>

    <input id="gName" placeholder="Group Name">
    <input id="gShortcut" placeholder="Shortcut">
    <input id="gCost" type="number" placeholder="Cost">

    <h4>Select Tests</h4>
    <div id="groupTests"></div>

    <div class="actions">
      <button class="neo-btn" onclick="saveGroup()">Save</button>
      <button class="neo-btn secondary" onclick="closeGroup()">Cancel</button>
    </div>
  </div>
</div>

<script src="../../api.js"></script>
<script>
let tests=[], groups=[], mode="all";
let normalIdCounter = 0;
let editTest=null, editGroup=null;

/* LOAD */
Promise.all([
fetch(API_BASE_URL + "/tests").then(r=>r.json()),
 fetch(API_BASE_URL + "/groups").then(r=>r.json())
]).then(([t,g])=>{
 tests=t;
 groups=g;
 render();
});

/* TABS */
function setMode(m,b){
 mode=m;
 document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
 b.classList.add("active");
 render();
}

/* MENU */
function closeMenus(){
 document.querySelectorAll(".menu-list").forEach(m=>m.style.display="none");
 document.querySelectorAll("#tbody tr.menu-open").forEach(row => row.classList.remove("menu-open"));
 document.body.classList.remove("menu-open");
}

function toggleMenu(btn){
 const menu = btn.nextElementSibling;
 const isOpen = menu && menu.style.display === "block";
 closeMenus();
 if (menu) {
  menu.style.display = isOpen ? "none" : "block";
  if (!isOpen) {
   const row = btn.closest("tr");
   if (row) {
     row.classList.add("menu-open");
   }
   document.body.classList.add("menu-open");
  }
 }
}

document.addEventListener("click", (event) => {
 if (!event.target.closest(".menu")) {
  closeMenus();
 }
});

function normalizeText(value){
  if (value === null || value === undefined) {
    return "";
  }
  return String(value).trim();
}

function formatCost(value){
  if (value === null || value === undefined || value === "") {
    return "—";
  }
  const numeric = Number(value);
  return Number.isFinite(numeric) ? `₹${numeric}` : "—";
}

function renderNormalValues(test){
 const params = Array.isArray(test.parameters) ? test.parameters : [];
 const hasMultiple = params.length > 1;
 const paramLines = params
  .map(param => {
    const normalText = normalizeText(param.normalText);
    if (!normalText) {
      return "";
    }
    const name = hasMultiple ? normalizeText(param.name) : "";
    return name ? `${name}: ${normalText}` : normalText;
  })
  .filter(Boolean);

 if (paramLines.length) {
  return paramLines.join("\n");
 }

 return (test.normalValues || [])
  .map(n => normalizeText(n.normalValue))
  .filter(Boolean)
  .join("\n");
}

/* RENDER */
function render(){
 tbody.innerHTML="";
 let i=1;

 if(mode!=="group"){
  tests.forEach(t=>{
   tbody.innerHTML+=`
   <tr>
    <td class="sno">${i++}</td>
    <td class="name">${t.testName || "-"}</td>
    <td class="category">${t.category || "—"}</td>
    <td class="shortcut">${t.shortcut || "—"}</td>
    <td class="normal">${renderNormalValues(t) || "—"}</td>
    <td class="cost">${formatCost(t.cost)}</td>
      <td class="active-col">
         <label class="switch">
           <input type="checkbox"
           id="active-test-${t.id}"
           name="active-test-${t.id}"
           ${t.active ? "checked" : ""}
           onchange="toggleActive(${t.id}, this.checked)">
            <span class="slider"></span>
         </label>
      </td>
      <td class="options">
     <div class="menu">
      <button class="menu-btn" type="button" onclick="toggleMenu(this)">⋮</button>
      <div class="menu-list">
       <div onclick='openTest(${JSON.stringify(t)})'>Edit</div>
      ${t.used ? "" : `<div onclick='deleteTest(${t.id})'>Delete</div>`}      </div>
     </div>
    </td>
   </tr>`;
  });
 }

 if(mode!=="single"){
  groups.forEach(g=>{
   tbody.innerHTML+=`
   <tr>
    <td class="sno">${i++}</td>
    <td class="name">${g.groupName || "-"}</td>
    <td class="category">Group</td>
    <td class="shortcut">${g.shortcut || "—"}</td>
    <td class="normal">—</td>
    <td class="cost">${formatCost(g.cost)}</td>

    <td class="active-col">—</td>

    <td class="options">
     <div class="menu">
      <button class="menu-btn" type="button" onclick="toggleMenu(this)">⋮</button>
      <div class="menu-list">
       <div onclick='openGroup(${JSON.stringify(g)})'>Edit</div>
       <div onclick='deleteGroup(${g.id})'>Delete</div>
      </div>
     </div>
    </td>
   </tr>`;
  });
}
}

/* ===== SINGLE TEST ===== */
function openTest(t){
 editTest=t;
 tName.value=t.testName;
 tShortcut.value=t.shortcut;
 tCategory.value=t.category;
 tCost.value=t.cost;
 nBox.innerHTML="";
 normalIdCounter = 0;
 (t.normalValues||[]).forEach(n=>{
  const normalId = `normal-${t.id}-${normalIdCounter++}`;
  nBox.innerHTML+=`<div class="inline"><textarea id="${normalId}" name="${normalId}">${n.normalValue}</textarea></div>`;
 });
 testModal.style.display="flex";
}
function addNormal(){
  const normalId = `normal-${editTest ? editTest.id : "new"}-${normalIdCounter++}`;
  nBox.innerHTML+=`<textarea id="${normalId}" name="${normalId}"></textarea>`;
}
function saveTest(){
 fetch(API_BASE_URL + "/tests/" + editTest.id,{
  method:"PUT",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
    testName:tName.value,
    shortcut:tShortcut.value,
    category:tCategory.value,
    cost:+tCost.value,
    normalValues:[...nBox.querySelectorAll("textarea")].map(t=>({normalValue:t.value}))
  })
 }).then(()=>location.reload());
}
function closeTest(){testModal.style.display="none"}

/* ===== GROUP EDIT (MODAL, NO REDIRECT) ===== */
function openGroup(g){
 editGroup=g;
 gName.value=g.groupName;
 gShortcut.value=g.shortcut;
 gCost.value=g.cost;

 fetch(API_BASE_URL + "/groups/" + g.id)
 .then(r=>r.json())
 .then(d=>{
  groupTests.innerHTML="";
  tests.forEach(t=>{
   groupTests.innerHTML+=`
    <div class="inline neo" style="padding:8px">
      <input type="checkbox" id="group-test-${g.id}-${t.id}" name="group-test-${g.id}-${t.id}" value="${t.id}"
        ${(d.testIds||[]).includes(t.id)?"checked":""}>
      ${t.testName} (${t.shortcut})
    </div>`;
  });
  groupModal.style.display="flex";
 });
}
function saveGroup(){
 const ids=[...groupTests.querySelectorAll("input:checked")].map(i=>+i.value);
 fetch(API_BASE_URL + "/groups/" + editGroup.id,{
  method:"PUT",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
   groupName:gName.value,
   shortcut:gShortcut.value,
   cost:+gCost.value,
   testIds:ids
  })
 }).then(()=>location.reload());
}
function closeGroup(){groupModal.style.display="none"}

/* DELETE */
function deleteTest(id){
  if(!confirm("Delete test?")) return;

  fetch(API_BASE_URL + "/tests/" + id,{
    method:"DELETE"
  })
  .then(res=>{
    if(!res.ok){
      return res.text().then(msg=>alert(msg));
    }
    location.reload();
  })
  .catch(()=>{
    alert("Server error");
  });
}
function deleteGroup(id){
 if(confirm("Delete group?"))
  fetch(API_BASE_URL + "/groups/" + id,{method:"DELETE"})
   .then(()=>location.reload());
}
/* TOGGLE ACTIVE */
function toggleActive(id, state){
  fetch(`${API_BASE_URL}/tests/${id}/active`,{
    method:"PUT",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active: state })
  })
  .then(res=>{
    if(!res.ok){
      alert("Failed to update test status");
      location.reload(); // revert UI
    }
  })
  .catch(()=>{
    alert("Server error");
    location.reload();
  });
}
</script>

</body>
</html>
