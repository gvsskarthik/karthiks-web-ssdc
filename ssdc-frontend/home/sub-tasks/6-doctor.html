<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Doctors</title>
<link href="../../vendor/boxicons/css/boxicons.min.css" rel="stylesheet">

<style>
body {
  margin: 0;
  padding: 20px;
  font-family: Arial, sans-serif;
  background: #ecf0f3;
}
* {
  box-sizing: border-box;
}
.head-title {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
}
.head-title h1{
  font-size:36px;
  font-weight:600;
  margin:0;
}
.neo-btn {
  padding: 10px 18px;
  border-radius: 14px;
  background: #ecf0f3;
  box-shadow: 6px 6px 10px #c5c9cc,
              -6px -6px 10px #ffffff;
  border: none;
  cursor: pointer;
}
.search-box {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 15px;
}
.search-input {
  width: 260px;
  padding: 8px 14px;
  border-radius: 14px;
  background: #ecf0f3;
  box-shadow: inset 5px 5px 8px #c5c9cc,
              inset -5px -5px 8px #ffffff;
  border: none;
}
.table-box {
  border-radius: 20px;
  background: #ecf0f3;
  box-shadow: 10px 10px 20px #c5c9cc,
              -10px -10px 20px #ffffff;
  padding: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 12px;
}
tr {
  border-bottom: 1px solid #dcdde1;
}
.menu {
  position: relative;
  display: inline-flex;
  justify-content: center;
  width: 100%;
}
.menu-btn {
  cursor: pointer;
  font-size: 20px;
  line-height: 1;
  padding: 2px 8px;
}
.menu-list {
  display: none;
  position: absolute;
  right: 0;
  top: 22px;
  background: #ecf0f3;
  border-radius: 14px;
  box-shadow: 6px 6px 12px #c5c9cc,
              -6px -6px 12px #ffffff;
  z-index: 10;
  min-width: 120px;
}
.menu-list div {
  padding: 10px 16px;
  cursor: pointer;
  font-size: 13px;
}
.menu-list div:hover {
  background: #dde1e4;
}
.menu-list .danger {
  color: #c0392b;
}
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 20;
}
.neo-card {
  max-width: 520px;
  width: 100%;
  margin: auto;
  padding: 26px;
  border-radius: 24px;
  background: #ecf0f3;
  box-shadow: 10px 10px 20px #c5c9cc,
              -10px -10px 20px #ffffff;
}
.neo-card h2 {
  margin: 0 0 20px;
  text-align: center;
}
.form-group {
  margin-bottom: 16px;
}
.form-group label {
  font-size: 14px;
  color: #555;
}
.neo-input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 16px;
  background: #ecf0f3;
  box-shadow: inset 6px 6px 10px #c5c9cc,
              inset -6px -6px 10px #ffffff;
  border: none;
  outline: none;
}
.action-row {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}
.neo-btn.secondary {
  color: #555;
}
</style>
</head>

<body>

<div class="head-title">
  <h1>Doctors</h1>
  <button class="neo-btn" onclick="location.href='dr/new-doctor.html'">
    <i class="bx bx-plus"></i> New
  </button>
</div>

<div class="search-box">
  <input type="text" id="searchInput" class="search-input" placeholder="Search...">
</div>

<div class="table-box">
<table>
  <thead>
    <tr>
      <th>S.No</th>
      <th>Doctor Name</th>
      <th>Specialization</th>
      <th>Hospital</th>
      <th>Phone</th>
      <th>Monthly Profit (₹)</th>
      <th>Options</th>
    </tr>
  </thead>
  <tbody id="doctorTable"></tbody>
</table>
</div>

<div class="modal" id="editModal">
  <div class="neo-card">
    <h2>Edit Doctor</h2>
    <form id="editForm">
      <div class="form-group">
        <label for="editName">Doctor Name</label>
        <input type="text" id="editName" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editSpecialization">Specialization</label>
        <input type="text" id="editSpecialization" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editPhone">Phone Number</label>
        <input type="tel" id="editPhone" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editHospital">Hospital Name</label>
        <input type="text" id="editHospital" class="neo-input" required>
      </div>

      <div class="action-row">
        <button type="button" class="neo-btn secondary" id="cancelEdit">Cancel</button>
        <button type="submit" class="neo-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="../../api.js"></script>
<script>
const table = document.getElementById("doctorTable");
const searchInput = document.getElementById("searchInput");
const editModal = document.getElementById("editModal");
const editForm = document.getElementById("editForm");
const editName = document.getElementById("editName");
const editSpecialization = document.getElementById("editSpecialization");
const editPhone = document.getElementById("editPhone");
const editHospital = document.getElementById("editHospital");
const cancelEdit = document.getElementById("cancelEdit");

let doctors = [];
let editDoctorId = null;

function closeAllMenus() {
  document.querySelectorAll(".menu-list").forEach(m => {
    m.style.display = "none";
  });
}

function toggleMenu(btn) {
  const menu = btn.nextElementSibling;
  const isOpen = menu && menu.style.display === "block";
  closeAllMenus();
  if (menu) {
    menu.style.display = isOpen ? "none" : "block";
  }
}

function applySearch() {
  const search = searchInput.value.toLowerCase();
  document.querySelectorAll("#doctorTable tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(search) ? "" : "none";
  });
}

function renderDoctors() {
  table.innerHTML = "";
  doctors.forEach((d, i) => {
    table.innerHTML += `
      <tr>
        <td>${i + 1}</td>
        <td>${d.name || "-"}</td>
        <td>${d.specialization || "-"}</td>
        <td>${d.hospital || "-"}</td>
        <td>${d.phone || "-"}</td>
        <td>₹0</td>
        <td>
          <div class="menu">
            <span class="menu-btn" onclick="toggleMenu(this)">⋮</span>
            <div class="menu-list">
              <div onclick="openEdit(${d.id})">Edit</div>
              <div class="danger" onclick="deleteDoctor(${d.id})">Delete</div>
            </div>
          </div>
        </td>
      </tr>
    `;
  });
  applySearch();
}

function loadDoctors() {
  fetch(API_BASE_URL + "/doctors")
  .then(res => res.json())
  .then(data => {
    doctors = Array.isArray(data) ? data : [];
    renderDoctors();
  })
  .catch(err => {
    console.error("Error loading doctors", err);
    table.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center;color:#888">
          Failed to load doctors
        </td>
      </tr>
    `;
  });
}

function openEdit(id) {
  closeAllMenus();
  const doctor = doctors.find(d => d.id === id);
  if (!doctor) {
    alert("Doctor not found");
    return;
  }
  editDoctorId = id;
  editName.value = doctor.name || "";
  editSpecialization.value = doctor.specialization || "";
  editPhone.value = doctor.phone || "";
  editHospital.value = doctor.hospital || "";
  editModal.style.display = "flex";
}

function closeEditModal() {
  editDoctorId = null;
  editForm.reset();
  editModal.style.display = "none";
}

function deleteDoctor(id) {
  closeAllMenus();
  if (!confirm("Delete doctor permanently?")) return;

  fetch(`${API_BASE_URL}/doctors/${id}`, {
    method: "DELETE"
  })
  .then(res => {
    if (!res.ok) {
      return res.text().then(text => {
        throw new Error(text || "Failed to delete doctor");
      });
    }
    return res;
  })
  .then(() => loadDoctors())
  .catch(err => {
    console.error("Error deleting doctor", err);
    alert(err.message || "Error deleting doctor");
  });
}

editForm.addEventListener("submit", function (e) {
  e.preventDefault();
  if (editDoctorId == null) return;

  const doctor = {
    id: editDoctorId,
    name: editName.value.trim(),
    specialization: editSpecialization.value.trim(),
    phone: editPhone.value.trim(),
    hospital: editHospital.value.trim()
  };

  fetch(API_BASE_URL + "/doctors", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(doctor)
  })
  .then(res => {
    if (!res.ok) {
      throw new Error("Failed to save doctor");
    }
  })
  .then(() => {
    closeEditModal();
    loadDoctors();
  })
  .catch(err => {
    console.error("Error saving doctor", err);
    alert(err.message || "Error saving doctor");
  });
});

cancelEdit.addEventListener("click", closeEditModal);
editModal.addEventListener("click", function (e) {
  if (e.target === editModal) closeEditModal();
});
document.addEventListener("click", function (e) {
  if (!e.target.closest(".menu")) closeAllMenus();
});
searchInput.addEventListener("keyup", applySearch);

loadDoctors();
</script>

</body>
</html>
