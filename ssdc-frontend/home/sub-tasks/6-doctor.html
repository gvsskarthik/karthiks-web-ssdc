<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doctors</title>
<link href="../../vendor/boxicons/css/boxicons.min.css" rel="stylesheet">

<style>
:root{
  --radius-lg:22px;
  --radius-md:14px;
}
body{
  margin:0;
  padding:24px;
  min-height:100vh;
}
.page{
  max-width:1200px;
  margin:0 auto;
  display:grid;
  gap:18px;
}
.head-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:18px;
  animation:fadeUp .45s ease both;
}
.head-title h1{
  font-size:32px;
  font-weight:700;
  margin:0;
  letter-spacing:.3px;
}
.subtitle{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.neo-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}
.neo-btn:hover{transform:translateY(-1px)}
.neo-btn:active{transform:translateY(1px)}
.neo-btn.secondary{
  border:1px solid var(--line);
}
.search-box{
  position:relative;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 14px;
  border-radius:var(--radius-md);
  background:var(--bg-soft);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  animation:fadeUp .5s ease both;
}
.search-box i{
  font-size:18px;
  color:var(--muted);
}
.search-input{
  flex:1;
  border:none;
  background:transparent;
  outline:none;
  font-size:14px;
  color:var(--ink);
}
.table-box{
  border-radius:var(--radius-lg);
  padding:16px;
  animation:fadeUp .55s ease both;
}
.table-wrap{overflow-x:visible}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 10px;
  table-layout:fixed;
}
thead th{
  text-align:left;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.6px;
  color:var(--muted);
  padding:0 12px 6px;
}
.name,
.specialization,
.hospital{
  overflow-wrap:anywhere;
}
.sno{
  width:56px;
}
.name{
  width:200px;
}
.specialization{
  width:160px;
}
.hospital{
  width:180px;
}
.phone,
.num{
  white-space:nowrap;
}
.phone{
  width:140px;
}
.num{
  width:140px;
}
.center{
  width:90px;
}
tbody tr{
  background:var(--bg-soft);
  transition:transform .15s ease, box-shadow .15s ease;
}
tbody tr:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(20, 30, 45, 0.1);
}
body.menu-open tbody tr:hover{
  transform:none;
  box-shadow:none;
}
tbody tr.menu-open{
  position:relative;
  z-index:2;
}
tbody td{
  padding:12px;
  border-top:1px solid var(--line);
  border-bottom:1px solid var(--line);
}
tbody td:first-child{
  border-left:1px solid var(--line);
  border-radius:12px 0 0 12px;
}
tbody td:last-child{
  border-right:1px solid var(--line);
  border-radius:0 12px 12px 0;
}
.num{
  text-align:right;
  font-weight:600;
}
.profit{color:#1b7a3f}
.share{color:#c0781a}
.center{text-align:center}
.menu{
  position:relative;
  display:inline-flex;
  justify-content:center;
  width:100%;
}
.menu-btn{
  cursor:pointer;
  font-size:18px;
  line-height:1;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--bg-soft);
}
.menu-list{
  display:none;
  position:absolute;
  right:0;
  top:32px;
  background:var(--bg-soft);
  border-radius:14px;
  border:1px solid var(--line);
  box-shadow:0 12px 24px rgba(20, 30, 45, 0.12);
  z-index:30;
  min-width:120px;
  overflow:hidden;
}
.menu-list div{
  padding:10px 16px;
  cursor:pointer;
  font-size:13px;
}
.menu-list div:hover{background:var(--theme-surface-2)}
.menu-list .danger{color:var(--danger)}
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(26, 26, 26, 0.4);
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:20;
  backdrop-filter:blur(4px);
}
.neo-card{
  max-width:520px;
  width:100%;
  margin:auto;
  padding:26px;
  border-radius:24px;
}
.neo-card h2{
  margin:0 0 20px;
  text-align:center;
}
.form-group{margin-bottom:16px}
.form-group label{
  font-size:12px;
  color:var(--muted);
  letter-spacing:.4px;
  text-transform:uppercase;
}
.neo-input{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  background:var(--theme-field-bg);
  border:1px solid var(--line);
  outline:none;
  font-size:14px;
}
.action-row{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin-top:20px;
}
@keyframes fadeUp{
  from{opacity:0; transform:translateY(8px)}
  to{opacity:1; transform:translateY(0)}
}
@media (max-width:900px){
  body{padding:16px}
  .head-title{flex-direction:column; align-items:flex-start}
  .neo-btn{width:100%; justify-content:center}
}
@media (max-width:600px){
  .head-title h1{font-size:28px}
  .search-box{padding:10px 12px}
}
</style>
<link rel="stylesheet" href="theme.css">
</head>

<body>
<script src="theme-init.js"></script>

<div class="page">
  <div class="head-title">
    <div>
      <h1>Doctors</h1>
      <div class="subtitle">Monthly performance overview</div>
    </div>
    <button class="neo-btn" onclick="location.href='dr/new-doctor.html'">
      <i class="bx bx-plus"></i> New Doctor
    </button>
  </div>

  <div class="search-box">
    <i class="bx bx-search"></i>
    <input type="text" id="searchInput" class="search-input" placeholder="Search by name, hospital, phone...">
  </div>

  <div class="table-box">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="sno">S.No</th>
            <th class="name">Doctor Name</th>
            <th class="specialization">Specialization</th>
            <th class="hospital">Hospital</th>
            <th class="phone">Phone</th>
            <th class="num">This Month Profit (₹)</th>
            <th class="num">This Month Share (₹)</th>
            <th class="center">Options</th>
          </tr>
        </thead>
        <tbody id="doctorTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="editModal">
  <div class="neo-card">
    <h2>Edit Doctor</h2>
    <form id="editForm">
      <div class="form-group">
        <label for="editName">Doctor Name</label>
        <input type="text" id="editName" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editSpecialization">Specialization</label>
        <input type="text" id="editSpecialization" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editPhone">Phone Number</label>
        <input type="tel" id="editPhone" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editHospital">Hospital Name</label>
        <input type="text" id="editHospital" class="neo-input" required>
      </div>

      <div class="form-group">
        <label for="editCommissionRate">Share %</label>
        <input type="number" id="editCommissionRate" class="neo-input" min="0" max="100" step="0.01" inputmode="decimal">
      </div>

      <div class="action-row">
        <button type="button" class="neo-btn secondary" id="cancelEdit">Cancel</button>
        <button type="submit" class="neo-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="../../api.js"></script>
<script>
const table = document.getElementById("doctorTable");
const searchInput = document.getElementById("searchInput");
const editModal = document.getElementById("editModal");
const editForm = document.getElementById("editForm");
const editName = document.getElementById("editName");
const editSpecialization = document.getElementById("editSpecialization");
const editPhone = document.getElementById("editPhone");
const editHospital = document.getElementById("editHospital");
const editCommissionRate = document.getElementById("editCommissionRate");
const cancelEdit = document.getElementById("cancelEdit");

let doctors = [];
let editDoctorId = null;
let monthlyStats = new Map();

function parseNumber(value){
  const cleaned = String(value ?? "").replace(/,/g, "");
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : 0;
}

function formatMoney(value){
  return String(Math.round(parseNumber(value)));
}

function normalizeName(value){
  return String(value || "").trim().toLowerCase();
}

function parseDateValue(value){
  const raw = String(value || "").trim();
  if (!raw) {
    return null;
  }
  const isoMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (isoMatch) {
    const year = Number(isoMatch[1]);
    const month = Number(isoMatch[2]);
    const day = Number(isoMatch[3]);
    return new Date(Date.UTC(year, month - 1, day));
  }
  const parts = raw.split(/[\/-]/);
  if (parts.length === 3) {
    let year;
    let month;
    let day;
    if (parts[0].length === 4) {
      year = Number(parts[0]);
      month = Number(parts[1]);
      day = Number(parts[2]);
    } else {
      day = Number(parts[0]);
      month = Number(parts[1]);
      year = Number(parts[2]);
    }
    if (Number.isFinite(year) && Number.isFinite(month) && Number.isFinite(day)) {
      return new Date(Date.UTC(year, month - 1, day));
    }
  }
  const parsed = new Date(raw);
  if (Number.isNaN(parsed.getTime())) {
    return null;
  }
  return new Date(Date.UTC(
    parsed.getFullYear(),
    parsed.getMonth(),
    parsed.getDate()
  ));
}

function isCurrentMonth(date){
  if (!date) {
    return false;
  }
  const now = new Date();
  return date.getUTCFullYear() === now.getUTCFullYear()
    && date.getUTCMonth() === now.getUTCMonth();
}

function buildMonthlyStats(rows){
  const stats = new Map();
  (Array.isArray(rows) ? rows : []).forEach(row => {
    const date = parseDateValue(row?.date);
    if (!isCurrentMonth(date)) {
      return;
    }
    const key = normalizeName(row?.doctorName);
    if (!key) {
      return;
    }
    const current = stats.get(key) || { revenue: 0, commission: 0 };
    current.revenue += parseNumber(row?.billAmount);
    current.commission += parseNumber(row?.commissionAmount);
    stats.set(key, current);
  });
  return stats;
}

function closeAllMenus() {
  document.querySelectorAll(".menu-list").forEach(m => {
    m.style.display = "none";
  });
  document.querySelectorAll("#doctorTable tr.menu-open").forEach(row => {
    row.classList.remove("menu-open");
  });
  document.body.classList.remove("menu-open");
}

function toggleMenu(btn) {
  const menu = btn.nextElementSibling;
  const isOpen = menu && menu.style.display === "block";
  closeAllMenus();
  if (menu) {
    menu.style.display = isOpen ? "none" : "block";
    if (!isOpen) {
      const row = btn.closest("tr");
      if (row) {
        row.classList.add("menu-open");
      }
      document.body.classList.add("menu-open");
    }
  }
}

function applySearch() {
  const search = searchInput.value.toLowerCase();
  document.querySelectorAll("#doctorTable tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(search) ? "" : "none";
  });
}

function renderDoctors() {
  table.innerHTML = "";
  doctors.forEach((d, i) => {
    const key = normalizeName(d.name);
    const stats = key ? (monthlyStats.get(key) || { revenue: 0, commission: 0 }) : { revenue: 0, commission: 0 };
    const profit = stats.revenue - stats.commission;
    table.innerHTML += `
      <tr>
        <td class="sno">${i + 1}</td>
        <td class="name">${d.name || "-"}</td>
        <td class="specialization">${d.specialization || "-"}</td>
        <td class="hospital">${d.hospital || "-"}</td>
        <td class="phone">${d.phone || "-"}</td>
        <td class="num profit">₹${formatMoney(profit)}</td>
        <td class="num share">₹${formatMoney(stats.commission)}</td>
        <td class="center">
          <div class="menu">
            <span class="menu-btn" onclick="toggleMenu(this)">⋮</span>
            <div class="menu-list">
              <div onclick="openEdit(${d.id})">Edit</div>
              <div class="danger" onclick="deleteDoctor(${d.id})">Delete</div>
            </div>
          </div>
        </td>
      </tr>
    `;
  });
  applySearch();
}

function loadDoctors() {
  Promise.all([
    fetch(API_BASE_URL + "/doctors").then(res => res.json()),
    fetch(API_BASE_URL + "/accounts/details")
      .then(res => res.json())
      .catch(err => {
        console.error("Error loading account details", err);
        return [];
      })
  ])
  .then(([doctorData, detailRows]) => {
    doctors = Array.isArray(doctorData) ? doctorData : [];
    monthlyStats = buildMonthlyStats(detailRows);
    renderDoctors();
  })
  .catch(err => {
    console.error("Error loading doctors", err);
    table.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;color:#888">
          Failed to load doctors
        </td>
      </tr>
    `;
  });
}

function openEdit(id) {
  closeAllMenus();
  const doctor = doctors.find(d => d.id === id);
  if (!doctor) {
    alert("Doctor not found");
    return;
  }
  editDoctorId = id;
  editName.value = doctor.name || "";
  editSpecialization.value = doctor.specialization || "";
  editPhone.value = doctor.phone || "";
  editHospital.value = doctor.hospital || "";
  editCommissionRate.value =
    doctor.commissionRate == null ? "" : doctor.commissionRate;
  editModal.style.display = "flex";
}

function closeEditModal() {
  editDoctorId = null;
  editForm.reset();
  editModal.style.display = "none";
}

function deleteDoctor(id) {
  closeAllMenus();
  if (!confirm("Delete doctor permanently?")) return;

  fetch(`${API_BASE_URL}/doctors/${id}`, {
    method: "DELETE"
  })
  .then(res => {
    if (!res.ok) {
      return res.text().then(text => {
        throw new Error(text || "Failed to delete doctor");
      });
    }
    return res;
  })
  .then(() => loadDoctors())
  .catch(err => {
    console.error("Error deleting doctor", err);
    alert(err.message || "Error deleting doctor");
  });
}

editForm.addEventListener("submit", function (e) {
  e.preventDefault();
  if (editDoctorId == null) return;

  const doctor = {
    id: editDoctorId,
    name: editName.value.trim(),
    specialization: editSpecialization.value.trim(),
    phone: editPhone.value.trim(),
    hospital: editHospital.value.trim()
  };
  const commissionRateRaw = editCommissionRate.value.trim();
  const commissionRate =
    commissionRateRaw === "" ? null : Number(commissionRateRaw);
  if (commissionRate !== null && Number.isFinite(commissionRate)) {
    doctor.commissionRate = commissionRate;
  }

  fetch(API_BASE_URL + "/doctors", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(doctor)
  })
  .then(res => {
    if (!res.ok) {
      throw new Error("Failed to save doctor");
    }
  })
  .then(() => {
    closeEditModal();
    loadDoctors();
  })
  .catch(err => {
    console.error("Error saving doctor", err);
    alert(err.message || "Error saving doctor");
  });
});

cancelEdit.addEventListener("click", closeEditModal);
editModal.addEventListener("click", function (e) {
  if (e.target === editModal) closeEditModal();
});
document.addEventListener("click", function (e) {
  if (!e.target.closest(".menu")) closeAllMenus();
});
searchInput.addEventListener("keyup", applySearch);

loadDoctors();
</script>

</body>
</html>
