<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Accounts</title>
<link href="../../vendor/fonts/fonts.css" rel="stylesheet">

<style>
:root{
  --bg:#ecf0f3;
  --bg-soft:#f6f8fb;
  --text:#2f3a4a;
  --muted:#7a8594;
  --accent:#1f7a8c;
  --shadow-dark:#c5c9cc;
  --shadow-light:#ffffff;
  --radius-lg:22px;
  --radius-md:16px;
}
body{
  margin:0;
  padding:24px;
  font-family:"Poppins","Lato",Arial,sans-serif;
  background:radial-gradient(circle at 10% 0%, #f8fafc 0%, #edf1f4 35%, #e7ecf1 100%);
  color:var(--text);
  min-height:100vh;
}
.page{
  max-width:1200px;
  margin:0 auto;
}

/* ===== NEOMORPHIC ===== */
.neo{
  background:var(--bg);
  border-radius:var(--radius-lg);
  box-shadow:10px 10px 20px var(--shadow-dark),
             -10px -10px 20px var(--shadow-light);
}
.neo-pressed{
  box-shadow:inset 6px 6px 10px var(--shadow-dark),
             inset -6px -6px 10px var(--shadow-light);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:16px;
  margin-bottom:24px;
}
.header h1{
  font-size:32px;
  font-weight:700;
  margin:0;
  letter-spacing:.2px;
}
.header-actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.btn{
  padding:10px 16px;
  border:none;
  border-radius:14px;
  font-weight:600;
  background:var(--bg);
  color:var(--text);
  box-shadow:6px 6px 12px var(--shadow-dark),
             -6px -6px 12px var(--shadow-light);
  border:1px solid rgba(255,255,255,0.6);
  cursor:pointer;
}
.btn:active{
  box-shadow:inset 4px 4px 8px var(--shadow-dark),
             inset -4px -4px 8px var(--shadow-light);
}
.btn:hover{opacity:.9}

.summary{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-bottom:24px;
}
.summary-card{
  padding:18px 20px;
  position:relative;
  overflow:hidden;
  animation:rise .4s ease both;
}
.summary-card:nth-child(2){animation-delay:.05s}
.summary-card:nth-child(3){animation-delay:.1s}
.summary-card::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(31,122,140,0.08), transparent 60%);
  pointer-events:none;
}
.summary h4{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  letter-spacing:.6px;
}
.summary p{
  font-size:28px;
  font-weight:800;
  margin:6px 0 0;
}

.layout{
  display:grid;
  grid-template-columns:1fr;
  gap:24px;
  align-items:start;
}
.card{
  padding:20px;
  border-radius:var(--radius-lg);
  animation:rise .45s ease both;
}
.filter-card{
  width:100%;
  max-width:360px;
  padding:14px 16px;
}
.filter-card .card-head{
  margin-bottom:0;
}
.card-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:14px;
}
.card-head h3{
  margin:0;
  font-size:18px;
  letter-spacing:.2px;
}
.filter-head{
  flex-direction:column;
  align-items:stretch;
  gap:6px;
}
.neo-select{
  width:100%;
  height:36px;
  padding:0 12px;
  border:none;
  border-radius:12px;
  background:var(--bg);
  font-size:13px;
  color:var(--text);
  outline:none;
}
.neo-select{
  appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, var(--muted) 50%),
    linear-gradient(135deg, var(--muted) 50%, transparent 50%);
  background-position:
    calc(100% - 18px) 50%,
    calc(100% - 12px) 50%;
  background-size:6px 6px, 6px 6px;
  background-repeat:no-repeat;
  padding-right:32px;
}
.neo-input{
  width:100%;
  height:36px;
  padding:0 12px;
  border:none;
  border-radius:12px;
  background:var(--bg);
  font-size:13px;
  color:var(--text);
  outline:none;
}

/* LEFT */
.small{
  font-size:11px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.4px;
}

/* TABLE */
.table-wrap{
  max-height:520px;
  overflow:auto;
  border-radius:14px;
  border:1px solid #e2e6ea;
  background:#f7f9fb;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px 14px;
  font-size:13px;
  border-bottom:1px solid #e3e7eb;
}
th{
  background:#f2f5f7;
  text-transform:uppercase;
  font-size:11px;
  color:var(--muted);
  letter-spacing:.5px;
  position:sticky;
  top:0;
  z-index:1;
}
tbody tr:hover{
  background:rgba(255,255,255,0.6);
}
.num{
  text-align:right;
  font-variant-numeric:tabular-nums;
}
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  background:rgba(47,58,74,0.2);
  z-index:999;
}
.modal.is-open{display:flex}
.modal-card{
  width:100%;
  max-width:360px;
  padding:18px;
  border-radius:var(--radius-lg);
  background:var(--bg);
  box-shadow:10px 10px 20px var(--shadow-dark),
             -10px -10px 20px var(--shadow-light);
}
.modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.modal-head h4{
  margin:0;
  font-size:16px;
  letter-spacing:.2px;
}
.icon-btn{
  width:32px;
  height:32px;
  border:none;
  border-radius:10px;
  background:var(--bg);
  box-shadow:6px 6px 12px var(--shadow-dark),
             -6px -6px 12px var(--shadow-light);
  cursor:pointer;
}
.modal-body{
  display:grid;
  gap:10px;
}
.modal-body label{
  font-size:11px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.modal-actions{
  display:flex;
  gap:10px;
  margin-top:14px;
}
.modal-actions .btn{flex:1}

@keyframes rise{
  from{opacity:0; transform:translateY(8px);}
  to{opacity:1; transform:translateY(0);}
}

@media (max-width:980px){
  body{padding:16px;}
  .header{flex-direction:column; align-items:flex-start;}
  .summary{grid-template-columns:1fr;}
  .layout{grid-template-columns:1fr;}
  .table-wrap{max-height:none;}
}
@media (max-width:600px){
  .header h1{font-size:28px;}
  .summary p{font-size:24px;}
  .btn{width:100%; justify-content:center;}
}
</style>
</head>

<body>

<div class="page">
  <div class="header">
    <h1>Accounts</h1>
    <div class="header-actions">
    <button class="btn neo" id="dateRangeBtn">ðŸ“… Date Range</button>
    <button class="btn neo" id="exportExcel">â¬‡ Export Excel</button>
    </div>
  </div>

<!-- SUMMARY -->
<div class="summary">
  <div class="neo summary-card" id="sumRevenue"></div>
  <div class="neo summary-card" id="sumCommission"></div>
  <div class="neo summary-card" id="sumProfit"></div>
</div>

<div class="layout">

  <!-- LEFT -->
  <div class="neo card filter-card">
    <div class="card-head filter-head">
      <label class="small" for="doctor">Doctor Filter</label>
      <select id="doctor" class="neo-select neo-pressed">
        <option value="">All</option>
      </select>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="neo card">
    <div class="card-head">
      <h3 id="detailTitle">All Accounts</h3>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Report ID</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Bill</th>
            <th>Commission</th>
          </tr>
        </thead>
        <tbody id="detailsBody">
          <tr>
            <td colspan="6" style="text-align:center;color:#999">
              All accounts will appear here
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

</div>

<div class="modal" id="dateRangeModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4>Date Range</h4>
      <button class="icon-btn" id="closeDateRange" type="button">X</button>
    </div>
    <div class="modal-body">
      <label for="dateFrom">From</label>
      <input id="dateFrom" type="date" class="neo-input neo-pressed">
      <label for="dateTo">To</label>
      <input id="dateTo" type="date" class="neo-input neo-pressed">
    </div>
    <div class="modal-actions">
      <button class="btn neo" id="applyDateRange" type="button">Apply</button>
      <button class="btn neo" id="clearDateRange" type="button">Clear</button>
    </div>
  </div>
</div>

<script src="../../api.js"></script>
<script>
const apiPath = window.apiUrl || function (path) {
  return path.charAt(0) === "/" ? "/api" + path : "/api/" + path;
};

const sumRevenue = document.getElementById("sumRevenue");
const sumCommission = document.getElementById("sumCommission");
const sumProfit = document.getElementById("sumProfit");
const doctorSelect = document.getElementById("doctor");
const exportExcel = document.getElementById("exportExcel");
const dateRangeBtn = document.getElementById("dateRangeBtn");
const dateRangeModal = document.getElementById("dateRangeModal");
const closeDateRange = document.getElementById("closeDateRange");
const dateFromInput = document.getElementById("dateFrom");
const dateToInput = document.getElementById("dateTo");
const applyDateRange = document.getElementById("applyDateRange");
const clearDateRange = document.getElementById("clearDateRange");
const detailTitle = document.getElementById("detailTitle");
const detailsBody = document.getElementById("detailsBody");

let doctors = [];
let selectedDoctor = null;
let currentRows = [];
let currentDoctorFallback = "";
let dateRange = { from: null, to: null };

function parseNumber(value){
  const cleaned = String(value ?? "").replace(/,/g, "");
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : 0;
}

function formatNumber(value){
  return String(Math.round(parseNumber(value)));
}

function setSummaryMessage(message){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#3498db">${message}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#e67e22">${message}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#2ecc71">${message}</p>`;
}

function setSummaryValues(data){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#3498db">â‚¹${formatNumber(data?.totalRevenue)}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#e67e22">â‚¹${formatNumber(data?.totalCommission)}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#2ecc71">â‚¹${formatNumber(data?.netProfit)}</p>`;
}

function setDetailsMessage(message){
  detailsBody.innerHTML =
    `<tr><td colspan="6" style="text-align:center;color:#999">${message}</td></tr>`;
}

function renderDetails(rows, doctorNameFallback){
  if (!Array.isArray(rows) || rows.length === 0) {
    setDetailsMessage("No records found");
    return;
  }

  detailsBody.innerHTML = "";
  rows.forEach(r => {
    const doctorName = r.doctorName || doctorNameFallback || "-";
    detailsBody.innerHTML += `
      <tr>
        <td>${r.date || "-"}</td>
        <td>${r.reportId || "-"}</td>
        <td>${r.patientName || "-"}</td>
        <td>${doctorName}</td>
        <td class="num">â‚¹${formatNumber(r.billAmount)}</td>
        <td class="num" style="color:#e67e22">â‚¹${formatNumber(r.commissionAmount)}</td>
      </tr>
    `;
  });
}

function parseDateValue(value){
  const raw = String(value || "").trim();
  if (!raw) {
    return null;
  }
  const isoMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (isoMatch) {
    const year = Number(isoMatch[1]);
    const month = Number(isoMatch[2]);
    const day = Number(isoMatch[3]);
    return new Date(Date.UTC(year, month - 1, day));
  }
  const parts = raw.split(/[\/-]/);
  if (parts.length === 3) {
    let year;
    let month;
    let day;
    if (parts[0].length === 4) {
      year = Number(parts[0]);
      month = Number(parts[1]);
      day = Number(parts[2]);
    } else {
      day = Number(parts[0]);
      month = Number(parts[1]);
      year = Number(parts[2]);
    }
    if (Number.isFinite(year) && Number.isFinite(month) && Number.isFinite(day)) {
      return new Date(Date.UTC(year, month - 1, day));
    }
  }
  const parsed = new Date(raw);
  if (Number.isNaN(parsed.getTime())) {
    return null;
  }
  return new Date(Date.UTC(
    parsed.getFullYear(),
    parsed.getMonth(),
    parsed.getDate()
  ));
}

function applyDateFilter(rows){
  if (!dateRange.from && !dateRange.to) {
    return rows;
  }
  return rows.filter(row => {
    const rowDate = parseDateValue(row.date);
    if (!rowDate) {
      return false;
    }
    if (dateRange.from && rowDate < dateRange.from) {
      return false;
    }
    if (dateRange.to && rowDate > dateRange.to) {
      return false;
    }
    return true;
  });
}

function renderCurrentRows(rows, doctorNameFallback){
  const filtered = applyDateFilter(rows || []);
  renderDetails(filtered, doctorNameFallback);
}

async function fetchJson(url){
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`Request failed: ${response.status}`);
  }
  return response.json();
}

async function loadSummary(){
  setSummaryMessage("Loading...");
  try{
    const data = await fetchJson(apiPath("/accounts/summary"));
    setSummaryValues(data);
  } catch (err) {
    console.error("Failed to load summary", err);
    setSummaryValues({
      totalRevenue: 0,
      totalCommission: 0,
      netProfit: 0
    });
  }
}

async function loadAllDetails(){
  detailTitle.innerText = "All Accounts";
  setDetailsMessage("Loading...");
  try{
    const rows = await fetchJson(apiPath("/accounts/details"));
    currentRows = Array.isArray(rows) ? rows : [];
    currentDoctorFallback = "";
    renderCurrentRows(currentRows);
  } catch (err) {
    console.error("Failed to load all account details", err);
    setDetailsMessage("Failed to load");
  }
}

async function loadDoctors(){
  doctorSelect.innerHTML = `<option value="">All</option>`;
  try{
    const data = await fetchJson(apiPath("/accounts/doctors"));
    if (!Array.isArray(data) || data.length === 0) {
      doctors = [];
      return;
    }
    doctors = data;
    renderDoctorOptions();
  } catch (err) {
    console.error("Failed to load doctors", err);
  }
}

function renderDoctorOptions(){
  const fragment = document.createDocumentFragment();
  doctors.forEach(d => {
    if (!d.doctorName) {
      return;
    }
    const option = document.createElement("option");
    option.value = d.doctorId;
    option.textContent = d.doctorName;
    fragment.appendChild(option);
  });
  doctorSelect.appendChild(fragment);
}

function getExportState(){
  const selectedId = doctorSelect.value;
  if (!selectedId) {
    return { doctorId: null, doctorName: "All" };
  }
  const doc = doctors.find(d => String(d.doctorId) === String(selectedId));
  return {
    doctorId: selectedId,
    doctorName: (doc && doc.doctorName) ? doc.doctorName : "Doctor"
  };
}

async function selectDoctor(id){
  selectedDoctor = id;
  const doc = doctors.find(d => String(d.doctorId) === String(id));
  if (!doc) {
    detailTitle.innerText = "No Results";
    setDetailsMessage("No records found");
    return;
  }

  detailTitle.innerText =
    `Billing Details: ${doc.doctorName || "Doctor"} (${formatNumber(doc.commissionRate)}%)`;
  setDetailsMessage("Loading...");

  try{
    const rows = await fetchJson(
      apiPath(`/accounts/doctor/${encodeURIComponent(id)}/details`)
    );

    currentRows = Array.isArray(rows) ? rows : [];
    currentDoctorFallback = doc.doctorName || "Doctor";
    renderCurrentRows(currentRows, currentDoctorFallback);
  } catch (err) {
    console.error("Failed to load doctor details", err);
    setDetailsMessage("Failed to load");
  }
}

function init(){
  loadSummary();
  loadDoctors();
  loadAllDetails();

  doctorSelect.addEventListener("change", () => {
    const value = doctorSelect.value;
    if (!value) {
      selectedDoctor = null;
      loadAllDetails();
      return;
    }
    selectDoctor(value);
  });

  exportExcel.addEventListener("click", () => {
    const state = getExportState();
    localStorage.setItem("accountsExportFilter", JSON.stringify(state));
    window.open("export.html", "_blank");
  });

  dateRangeBtn.addEventListener("click", () => {
    dateRangeModal.classList.add("is-open");
    dateRangeModal.setAttribute("aria-hidden", "false");
  });

  closeDateRange.addEventListener("click", () => {
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });

  dateRangeModal.addEventListener("click", (event) => {
    if (event.target === dateRangeModal) {
      dateRangeModal.classList.remove("is-open");
      dateRangeModal.setAttribute("aria-hidden", "true");
    }
  });

  applyDateRange.addEventListener("click", () => {
    const fromDate = parseDateValue(dateFromInput.value);
    const toDate = parseDateValue(dateToInput.value);
    if (fromDate && toDate && fromDate > toDate) {
      alert("From date must be before To date.");
      return;
    }
    dateRange = { from: fromDate, to: toDate };
    renderCurrentRows(currentRows, currentDoctorFallback);
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });

  clearDateRange.addEventListener("click", () => {
    dateFromInput.value = "";
    dateToInput.value = "";
    dateRange = { from: null, to: null };
    renderCurrentRows(currentRows, currentDoctorFallback);
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });
}

init();
</script>

</body>
</html>
