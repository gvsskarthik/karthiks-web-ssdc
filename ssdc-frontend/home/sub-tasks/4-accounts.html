<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Accounts</title>

<style>
body{
  margin:0;
  padding:20px;
  font-family:Arial, sans-serif;
  background:#ecf0f3;
  color:#555;
}

/* ===== NEOMORPHIC ===== */
.neo{
  background:#ecf0f3;
  border-radius:20px;
  box-shadow:8px 8px 16px #c5c9cc,
             -8px -8px 16px #ffffff;
}
.neo-pressed{
  box-shadow:inset 6px 6px 10px #c5c9cc,
             inset -6px -6px 10px #ffffff;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.btn{
  padding:10px 18px;
  border:none;
  border-radius:16px;
  font-weight:600;
  cursor:pointer;
}
.btn:hover{opacity:.9}

.summary{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
  margin-bottom:30px;
}
.summary h4{
  font-size:12px;
  text-transform:uppercase;
  color:#888;
}
.summary p{
  font-size:28px;
  font-weight:800;
}

.layout{
  display:grid;
  grid-template-columns:1fr 2fr;
  gap:30px;
}

/* LEFT */
.doctor{
  padding:14px;
  border-radius:16px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.doctor:hover{background:rgba(255,255,255,.3)}
.doctor.active{box-shadow:inset 5px 5px 8px #c5c9cc,
               inset -5px -5px 8px #ffffff;}

.small{
  font-size:11px;
  color:#999;
  font-weight:bold;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  font-size:13px;
  border:1px solid #ddd;
}
th{
  background:#f4f6f8;
  text-transform:uppercase;
  font-size:11px;
  color:#777;
}
</style>
</head>

<body>

<div class="header">
  <h2>Financial Accounts</h2>
  <div>
    <button class="btn neo">ðŸ“… Date Range</button>
    <button class="btn neo">â¬‡ Export Excel</button>
  </div>
</div>

<!-- SUMMARY -->
<div class="summary">
  <div class="neo" id="sumRevenue"></div>
  <div class="neo" id="sumCommission"></div>
  <div class="neo" id="sumProfit"></div>
</div>

<div class="layout">

  <!-- LEFT -->
  <div class="neo" style="padding:20px">
    <h3>Doctor Wise Billing</h3>
    <div id="doctorList"></div>
  </div>

  <!-- RIGHT -->
  <div class="neo" style="padding:20px">
    <h3 id="detailTitle">Select a doctor</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Report ID</th>
          <th>Patient</th>
          <th>Bill</th>
          <th>Commission</th>
        </tr>
      </thead>
      <tbody id="detailsBody">
        <tr>
          <td colspan="5" style="text-align:center;color:#999">
            Select a doctor to see details
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<script src="../../api.js"></script>
<script>
const apiPath = window.apiUrl || function (path) {
  return path.charAt(0) === "/" ? "/api" + path : "/api/" + path;
};

const sumRevenue = document.getElementById("sumRevenue");
const sumCommission = document.getElementById("sumCommission");
const sumProfit = document.getElementById("sumProfit");
const doctorList = document.getElementById("doctorList");
const detailTitle = document.getElementById("detailTitle");
const detailsBody = document.getElementById("detailsBody");

let doctors = [];
let selectedDoctor = null;

function parseNumber(value){
  const cleaned = String(value ?? "").replace(/,/g, "");
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : 0;
}

function formatNumber(value){
  return String(Math.round(parseNumber(value)));
}

function setSummaryMessage(message){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#3498db">${message}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#e67e22">${message}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#2ecc71">${message}</p>`;
}

function setSummaryValues(data){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#3498db">â‚¹${formatNumber(data?.totalRevenue)}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#e67e22">â‚¹${formatNumber(data?.totalCommission)}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#2ecc71">â‚¹${formatNumber(data?.netProfit)}</p>`;
}

function setDoctorListMessage(message){
  doctorList.innerHTML =
    `<div class="small" style="padding:6px 0">${message}</div>`;
}

function setDetailsMessage(message){
  detailsBody.innerHTML =
    `<tr><td colspan="5" style="text-align:center;color:#999">${message}</td></tr>`;
}

async function fetchJson(url){
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`Request failed: ${response.status}`);
  }
  return response.json();
}

async function loadSummary(){
  setSummaryMessage("Loading...");
  try{
    const data = await fetchJson(apiPath("/accounts/summary"));
    setSummaryValues(data);
  } catch (err) {
    console.error("Failed to load summary", err);
    setSummaryMessage("Failed to load");
  }
}

async function loadDoctors(){
  setDoctorListMessage("Loading...");
  try{
    const data = await fetchJson(apiPath("/accounts/doctors"));
    if (!Array.isArray(data) || data.length === 0) {
      doctors = [];
      setDoctorListMessage("No records found");
      return;
    }
    doctors = data;
    renderDoctors();
  } catch (err) {
    console.error("Failed to load doctors", err);
    setDoctorListMessage("Failed to load");
  }
}

function renderDoctors(){
  doctorList.innerHTML = "";
  doctors.forEach(d => {
    const div = document.createElement("div");
    div.className = "doctor neo";
    if (selectedDoctor === d.doctorId) {
      div.classList.add("active");
    }

    div.innerHTML = `
      <div>
        <b>${d.doctorName || "-"}</b>
        <div class="small">${formatNumber(d.patientCount)} patients</div>
      </div>
      <div style="text-align:right">
        <b>â‚¹${formatNumber(d.totalBill)}</b>
        <div class="small">Comm â‚¹${formatNumber(d.totalCommission)}</div>
      </div>
    `;
    div.onclick = () => selectDoctor(d.doctorId);
    doctorList.appendChild(div);
  });
}

async function selectDoctor(id){
  selectedDoctor = id;
  renderDoctors();

  const doc = doctors.find(d => d.doctorId === id);
  if (!doc) {
    detailTitle.innerText = "Select a doctor";
    setDetailsMessage("No records found");
    return;
  }

  detailTitle.innerText =
    `Billing Details: ${doc.doctorName || "Doctor"} (${formatNumber(doc.commissionRate)}%)`;
  setDetailsMessage("Loading...");

  try{
    const rows = await fetchJson(
      apiPath(`/accounts/doctor/${encodeURIComponent(id)}/details`)
    );

    if (!Array.isArray(rows) || rows.length === 0) {
      setDetailsMessage("No records found");
      return;
    }

    detailsBody.innerHTML = "";
    rows.forEach(r => {
      detailsBody.innerHTML += `
        <tr>
          <td>${r.date || "-"}</td>
          <td>${r.reportId || "-"}</td>
          <td>${r.patientName || "-"}</td>
          <td>â‚¹${formatNumber(r.billAmount)}</td>
          <td style="color:#e67e22">â‚¹${formatNumber(r.commissionAmount)}</td>
        </tr>
      `;
    });
  } catch (err) {
    console.error("Failed to load doctor details", err);
    setDetailsMessage("Failed to load");
  }
}

function init(){
  detailTitle.innerText = "Select a doctor";
  setDetailsMessage("Select a doctor to see details");
  loadSummary();
  loadDoctors();
}

init();
</script>

</body>
</html>
