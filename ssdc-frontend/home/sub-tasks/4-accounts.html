<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accounts</title>
<link href="../../vendor/fonts/fonts.css" rel="stylesheet">

<style>
:root{
  --bg:#f6f1e7;
  --bg-soft:#fffaf2;
  --ink:#1e262d;
  --muted:#6b737c;
  --accent:#0f766e;
  --accent-strong:#0b5f58;
  --warm:#d0812a;
  --danger:#c0392b;
  --success:#1b7a3f;
  --line:#e3d9c9;
  --shadow:0 18px 40px rgba(28, 41, 61, 0.12);
  --radius-lg:22px;
  --radius-md:14px;
  --radius-sm:10px;
}
body{
  margin:0;
  padding:24px;
  font-family:"Poppins","Lato",sans-serif;
  background:
    radial-gradient(circle at 12% 8%, #ffffff 0%, #f8f3ea 40%, #f2ede2 100%),
    linear-gradient(135deg, #f2ede2 0%, #f9f5ee 100%);
  color:var(--ink);
  min-height:100vh;
}
.page{
  max-width:1200px;
  margin:0 auto;
  display:grid;
  gap:20px;
}

.neo{
  background:var(--bg-soft);
  border-radius:var(--radius-lg);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
}
.neo-pressed{
  background:#fff;
  border:1px solid var(--line);
  box-shadow:inset 0 1px 2px rgba(20, 30, 45, 0.12);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  animation:fadeUp .45s ease both;
}
.header h1{
  font-size:32px;
  font-weight:700;
  margin:0;
  letter-spacing:.2px;
}
.subtitle{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.header-actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border:none;
  border-radius:999px;
  font-weight:600;
  background:linear-gradient(135deg, var(--accent), #1aa191);
  color:#fff;
  box-shadow:0 12px 24px rgba(15, 118, 110, 0.18);
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  background:var(--bg-soft);
  color:var(--ink);
  border:1px solid var(--line);
  box-shadow:none;
}

.summary{
  display:grid;
  grid-template-columns:repeat(4, minmax(0, 1fr));
  gap:16px;
}
.summary-card{
  padding:18px 20px;
  position:relative;
  overflow:hidden;
  animation:fadeUp .5s ease both;
}
.summary-card:nth-child(2){animation-delay:.05s}
.summary-card:nth-child(3){animation-delay:.1s}
.summary-card:nth-child(4){animation-delay:.15s}
.summary-card::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(15, 118, 110, 0.12), transparent 60%);
  pointer-events:none;
}
.summary-card:nth-child(2)::after{
  background:linear-gradient(135deg, rgba(192, 57, 43, 0.12), transparent 60%);
}
.summary-card:nth-child(3)::after{
  background:linear-gradient(135deg, rgba(208, 129, 42, 0.12), transparent 60%);
}
.summary-card:nth-child(4)::after{
  background:linear-gradient(135deg, rgba(27, 122, 63, 0.12), transparent 60%);
}
.summary h4{
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
  letter-spacing:.6px;
}
.summary p{
  font-size:26px;
  font-weight:800;
  margin:6px 0 0;
}

.layout{
  display:grid;
  grid-template-columns:1fr;
  gap:24px;
  align-items:start;
}
.card{
  padding:18px;
  border-radius:var(--radius-lg);
  animation:fadeUp .55s ease both;
}
.filter-card{
  width:100%;
  max-width:none;
  padding:14px 16px;
}
.filter-card .card-head{
  margin-bottom:0;
}
.card-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:14px;
}
.card-head h3{
  margin:0;
  font-size:18px;
  letter-spacing:.2px;
}
.filter-head{
  flex-direction:column;
  align-items:stretch;
  gap:6px;
}
.neo-select{
  width:100%;
  height:36px;
  padding:0 12px;
  border:none;
  border-radius:12px;
  background:#fff;
  font-size:13px;
  color:var(--ink);
  outline:none;
  border:1px solid var(--line);
}
.neo-select{
  appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, var(--muted) 50%),
    linear-gradient(135deg, var(--muted) 50%, transparent 50%);
  background-position:
    calc(100% - 18px) 50%,
    calc(100% - 12px) 50%;
  background-size:6px 6px, 6px 6px;
  background-repeat:no-repeat;
  padding-right:32px;
}
.neo-input{
  width:100%;
  height:36px;
  padding:0 12px;
  border:none;
  border-radius:12px;
  background:#fff;
  font-size:13px;
  color:var(--ink);
  outline:none;
  border:1px solid var(--line);
}

.small{
  font-size:11px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.muted{color:var(--muted)}

.table-wrap{
  max-height:520px;
  overflow:auto;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--line);
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:760px;
}
th,td{
  padding:10px 12px;
  border:1px solid var(--line);
  font-size:13px;
}
thead th{
  text-align:left;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.6px;
  color:var(--muted);
  background:#f8f3ea;
}
.total-row td{
  font-weight:700;
  background:#f8f3ea;
}
.total-row td:first-child{
  text-align:left;
}
.num{
  text-align:right;
  font-variant-numeric:tabular-nums;
  font-weight:600;
}
.commission{color:var(--warm)}

.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  background:rgba(26, 26, 26, 0.4);
  backdrop-filter:blur(4px);
  z-index:999;
}
.modal.is-open{display:flex}
.modal-card{
  width:100%;
  max-width:360px;
  padding:18px;
  border-radius:var(--radius-lg);
  background:var(--bg-soft);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
}
.modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.modal-head h4{
  margin:0;
  font-size:16px;
  letter-spacing:.2px;
}
.icon-btn{
  width:32px;
  height:32px;
  border:none;
  border-radius:10px;
  background:var(--bg-soft);
  border:1px solid var(--line);
  cursor:pointer;
}
.modal-body{
  display:grid;
  gap:10px;
}
.modal-body label{
  font-size:11px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.modal-actions{
  display:flex;
  gap:10px;
  margin-top:14px;
}
.modal-actions .btn{flex:1}

@keyframes fadeUp{
  from{opacity:0; transform:translateY(8px);}
  to{opacity:1; transform:translateY(0);}
}

@media (max-width:980px){
  body{padding:16px;}
  .header{flex-direction:column; align-items:flex-start;}
  .summary{grid-template-columns:repeat(2, minmax(0, 1fr));}
  .table-wrap{max-height:none;}
}
@media (max-width:640px){
  .header h1{font-size:28px;}
  .summary{grid-template-columns:1fr;}
  .summary p{font-size:24px;}
  .btn{width:100%; justify-content:center;}
}
</style>
  <link rel="stylesheet" href="theme.css">
</head>

<body>

<div class="page">
  <div class="header">
    <div>
      <h1>Accounts</h1>
      <div class="subtitle">Revenue, discounts, and commissions</div>
    </div>
    <div class="header-actions">
    <button class="btn secondary" id="dateRangeBtn">ðŸ“… Date Range</button>
    <button class="btn" id="exportExcel">â¬‡ Export Excel</button>
    </div>
  </div>

<!-- SUMMARY -->
<div class="summary">
  <div class="neo summary-card" id="sumRevenue"></div>
  <div class="neo summary-card" id="sumDiscount"></div>
  <div class="neo summary-card" id="sumCommission"></div>
  <div class="neo summary-card" id="sumProfit"></div>
</div>

<div class="layout">

  <!-- LEFT -->
  <div class="neo card filter-card">
    <div class="card-head filter-head">
      <label class="small" for="doctor">Doctor Filter</label>
      <select id="doctor" class="neo-select neo-pressed">
        <option value="">All</option>
      </select>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="neo card">
    <div class="card-head">
      <h3 id="detailTitle">All Accounts</h3>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Report ID</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th class="num">Bill</th>
            <th class="num">Commission</th>
          </tr>
        </thead>
        <tbody id="detailsBody">
          <tr>
            <td colspan="6" class="muted" style="text-align:center">
              All accounts will appear here
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

</div>

<div class="modal" id="dateRangeModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h4>Date Range</h4>
      <button class="icon-btn" id="closeDateRange" type="button">X</button>
    </div>
    <div class="modal-body">
      <label for="dateFrom">From</label>
      <input id="dateFrom" type="date" class="neo-input neo-pressed">
      <label for="dateTo">To</label>
      <input id="dateTo" type="date" class="neo-input neo-pressed">
    </div>
    <div class="modal-actions">
      <button class="btn" id="applyDateRange" type="button">Apply</button>
      <button class="btn secondary" id="clearDateRange" type="button">Clear</button>
    </div>
  </div>
</div>

<script src="../../api.js"></script>
<script>
const apiPath = window.apiUrl || function (path) {
  return path.charAt(0) === "/" ? "/api" + path : "/api/" + path;
};

const sumRevenue = document.getElementById("sumRevenue");
const sumDiscount = document.getElementById("sumDiscount");
const sumCommission = document.getElementById("sumCommission");
const sumProfit = document.getElementById("sumProfit");
const doctorSelect = document.getElementById("doctor");
const exportExcel = document.getElementById("exportExcel");
const dateRangeBtn = document.getElementById("dateRangeBtn");
const dateRangeModal = document.getElementById("dateRangeModal");
const closeDateRange = document.getElementById("closeDateRange");
const dateFromInput = document.getElementById("dateFrom");
const dateToInput = document.getElementById("dateTo");
const applyDateRange = document.getElementById("applyDateRange");
const clearDateRange = document.getElementById("clearDateRange");
const detailTitle = document.getElementById("detailTitle");
const detailsBody = document.getElementById("detailsBody");

let doctors = [];
let selectedDoctor = null;
let currentRows = [];
let currentDoctorFallback = "";
let dateRange = { from: null, to: null };

function parseNumber(value){
  const cleaned = String(value ?? "").replace(/,/g, "");
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : 0;
}

function formatNumber(value){
  return String(Math.round(parseNumber(value)));
}

function setSummaryMessage(message){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#0f766e">${message}</p>`;
  sumDiscount.innerHTML =
    `<h4>Discounts Given</h4><p style="color:#c0392b">${message}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#d0812a">${message}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#1b7a3f">${message}</p>`;
}

function setSummaryValues(data){
  sumRevenue.innerHTML =
    `<h4>Total Revenue</h4><p style="color:#0f766e">â‚¹${formatNumber(data?.totalRevenue)}</p>`;
  sumDiscount.innerHTML =
    `<h4>Discounts Given</h4><p style="color:#c0392b">â‚¹${formatNumber(data?.totalDiscount)}</p>`;
  sumCommission.innerHTML =
    `<h4>Total Commission</h4><p style="color:#d0812a">â‚¹${formatNumber(data?.totalCommission)}</p>`;
  sumProfit.innerHTML =
    `<h4>Net Profit</h4><p style="color:#1b7a3f">â‚¹${formatNumber(data?.netProfit)}</p>`;
}

function setDetailsMessage(message){
  detailsBody.innerHTML =
    `<tr><td colspan="6" class="muted" style="text-align:center">${message}</td></tr>`;
}

function renderDetails(rows, doctorNameFallback){
  if (!Array.isArray(rows) || rows.length === 0) {
    setDetailsMessage("No records found");
    return;
  }

  let totalBill = 0;
  let totalCommission = 0;
  let html = "";

  rows.forEach(r => {
    const doctorName = r.doctorName || doctorNameFallback || "-";
    const bill = parseNumber(r.billAmount);
    const commission = parseNumber(r.commissionAmount);
    totalBill += bill;
    totalCommission += commission;
    html += `
      <tr>
        <td>${r.date || "-"}</td>
        <td>${r.reportId || "-"}</td>
        <td>${r.patientName || "-"}</td>
        <td>${doctorName}</td>
        <td class="num">â‚¹${formatNumber(bill)}</td>
        <td class="num commission">â‚¹${formatNumber(commission)}</td>
      </tr>
    `;
  });

  html += `
    <tr class="total-row">
      <td colspan="4">Total</td>
      <td class="num">â‚¹${formatNumber(totalBill)}</td>
      <td class="num commission">â‚¹${formatNumber(totalCommission)}</td>
    </tr>
  `;

  detailsBody.innerHTML = html;
}

function parseDateValue(value){
  const raw = String(value || "").trim();
  if (!raw) {
    return null;
  }
  const isoMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (isoMatch) {
    const year = Number(isoMatch[1]);
    const month = Number(isoMatch[2]);
    const day = Number(isoMatch[3]);
    return new Date(Date.UTC(year, month - 1, day));
  }
  const parts = raw.split(/[\/-]/);
  if (parts.length === 3) {
    let year;
    let month;
    let day;
    if (parts[0].length === 4) {
      year = Number(parts[0]);
      month = Number(parts[1]);
      day = Number(parts[2]);
    } else {
      day = Number(parts[0]);
      month = Number(parts[1]);
      year = Number(parts[2]);
    }
    if (Number.isFinite(year) && Number.isFinite(month) && Number.isFinite(day)) {
      return new Date(Date.UTC(year, month - 1, day));
    }
  }
  const parsed = new Date(raw);
  if (Number.isNaN(parsed.getTime())) {
    return null;
  }
  return new Date(Date.UTC(
    parsed.getFullYear(),
    parsed.getMonth(),
    parsed.getDate()
  ));
}

function applyDateFilter(rows){
  if (!dateRange.from && !dateRange.to) {
    return rows;
  }
  return rows.filter(row => {
    const rowDate = parseDateValue(row.date);
    if (!rowDate) {
      return false;
    }
    if (dateRange.from && rowDate < dateRange.from) {
      return false;
    }
    if (dateRange.to && rowDate > dateRange.to) {
      return false;
    }
    return true;
  });
}

function renderCurrentRows(rows, doctorNameFallback){
  const filtered = applyDateFilter(rows || []);
  renderDetails(filtered, doctorNameFallback);
}

async function fetchJson(url){
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`Request failed: ${response.status}`);
  }
  return response.json();
}

async function loadSummary(){
  setSummaryMessage("Loading...");
  try{
    const data = await fetchJson(apiPath("/accounts/summary"));
    setSummaryValues(data);
  } catch (err) {
    console.error("Failed to load summary", err);
    setSummaryValues({
      totalRevenue: 0,
      totalDiscount: 0,
      totalCommission: 0,
      netProfit: 0
    });
  }
}

async function loadAllDetails(){
  detailTitle.innerText = "All Accounts";
  setDetailsMessage("Loading...");
  try{
    const rows = await fetchJson(apiPath("/accounts/details"));
    currentRows = Array.isArray(rows) ? rows : [];
    currentDoctorFallback = "";
    renderCurrentRows(currentRows);
  } catch (err) {
    console.error("Failed to load all account details", err);
    setDetailsMessage("Failed to load");
  }
}

async function loadDoctors(){
  doctorSelect.innerHTML = `<option value="">All</option>`;
  try{
    const data = await fetchJson(apiPath("/accounts/doctors"));
    if (!Array.isArray(data) || data.length === 0) {
      doctors = [];
      return;
    }
    doctors = data;
    renderDoctorOptions();
  } catch (err) {
    console.error("Failed to load doctors", err);
  }
}

function renderDoctorOptions(){
  const fragment = document.createDocumentFragment();
  doctors.forEach(d => {
    if (!d.doctorName) {
      return;
    }
    const option = document.createElement("option");
    option.value = d.doctorId;
    option.textContent = d.doctorName;
    fragment.appendChild(option);
  });
  doctorSelect.appendChild(fragment);
}

function getExportState(){
  const selectedId = doctorSelect.value;
  if (!selectedId) {
    return { doctorId: null, doctorName: "All" };
  }
  const doc = doctors.find(d => String(d.doctorId) === String(selectedId));
  return {
    doctorId: selectedId,
    doctorName: (doc && doc.doctorName) ? doc.doctorName : "Doctor"
  };
}

async function selectDoctor(id){
  selectedDoctor = id;
  const doc = doctors.find(d => String(d.doctorId) === String(id));
  if (!doc) {
    detailTitle.innerText = "No Results";
    setDetailsMessage("No records found");
    return;
  }

  detailTitle.innerText =
    `Billing Details: ${doc.doctorName || "Doctor"} (${formatNumber(doc.commissionRate)}%)`;
  setDetailsMessage("Loading...");

  try{
    const rows = await fetchJson(
      apiPath(`/accounts/doctor/${encodeURIComponent(id)}/details`)
    );

    currentRows = Array.isArray(rows) ? rows : [];
    currentDoctorFallback = doc.doctorName || "Doctor";
    renderCurrentRows(currentRows, currentDoctorFallback);
  } catch (err) {
    console.error("Failed to load doctor details", err);
    setDetailsMessage("Failed to load");
  }
}

function init(){
  loadSummary();
  loadDoctors();
  loadAllDetails();

  doctorSelect.addEventListener("change", () => {
    const value = doctorSelect.value;
    if (!value) {
      selectedDoctor = null;
      loadAllDetails();
      return;
    }
    selectDoctor(value);
  });

  exportExcel.addEventListener("click", () => {
    const state = getExportState();
    localStorage.setItem("accountsExportFilter", JSON.stringify(state));
    window.open("export.html", "_blank");
  });

  dateRangeBtn.addEventListener("click", () => {
    dateRangeModal.classList.add("is-open");
    dateRangeModal.setAttribute("aria-hidden", "false");
  });

  closeDateRange.addEventListener("click", () => {
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });

  dateRangeModal.addEventListener("click", (event) => {
    if (event.target === dateRangeModal) {
      dateRangeModal.classList.remove("is-open");
      dateRangeModal.setAttribute("aria-hidden", "true");
    }
  });

  applyDateRange.addEventListener("click", () => {
    const fromDate = parseDateValue(dateFromInput.value);
    const toDate = parseDateValue(dateToInput.value);
    if (fromDate && toDate && fromDate > toDate) {
      alert("From date must be before To date.");
      return;
    }
    dateRange = { from: fromDate, to: toDate };
    renderCurrentRows(currentRows, currentDoctorFallback);
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });

  clearDateRange.addEventListener("click", () => {
    dateFromInput.value = "";
    dateToInput.value = "";
    dateRange = { from: null, to: null };
    renderCurrentRows(currentRows, currentDoctorFallback);
    dateRangeModal.classList.remove("is-open");
    dateRangeModal.setAttribute("aria-hidden", "true");
  });
}

init();
</script>

</body>
</html>
