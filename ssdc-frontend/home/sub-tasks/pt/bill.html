<!DOCTYPE html>
<!--suppress SpellCheckingInspection -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Bill</title>
<link rel="stylesheet" href="print-common.css">

<style>
table{
  font-size:12px;
}
th,td{
  padding:6px;
}
td.amount{text-align:right;width:140px}

/* TOTALS */
.totals{
  margin-top:16px;
  margin-left:auto;
  max-width:260px;
  font-size:13px;
}
.total-row{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
}
.total-row.grand{
  border-top:1px solid #000;
  font-weight:700;
  margin-top:6px;
  padding-top:8px;
}

/* BUTTONS */
.back{background:#7f8c8d;color:#fff}
</style>
</head>

<body>

<div class="neo-card" id="bill">

  <div class="header">
    <h2 spellcheck="false">SAI SREE SWETHA DIAGNOSTICS</h2>
    <p><b>BILL / RECEIPT</b></p>
  </div>

  <!-- PATIENT -->
  <div id="patient-info"></div>

  <!-- TABLE -->
  <table>
    <thead>
      <tr>
        <th>TEST NAME</th>
        <th style="width:140px">PRICE</th>
      </tr>
    </thead>
    <tbody id="billBody"></tbody>
  </table>

  <!-- TOTALS -->
  <div class="totals">
    <div class="total-row">
      <div class="label">Subtotal</div>
      <div id="subtotal">₹0</div>
    </div>
    <div class="total-row">
      <div class="label">Discount</div>
      <div id="discount">₹0</div>
    </div>
    <div class="total-row grand">
      <div class="label">Total</div>
      <div id="total">₹0</div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="btn back" onclick="goPatients()">BACK</button>
    <button class="btn print" onclick="window.print()">PRINT</button>
  </div>

</div>

<script src="patient-info.js"></script>
<script src="../../../api.js"></script>
<script>
const patient =
  JSON.parse(localStorage.getItem("currentPatient") || "{}");

function setText(id, value){
  const el = document.getElementById(id);
  if (el) {
    el.innerText = value;
  }
}

function formatMoney(value){
  const num = Number(value);
  if (!Number.isFinite(num)) return "0";
  return String(Math.round(num * 100) / 100);
}

function formatMoneyWithSymbol(value){
  return `₹${formatMoney(value)}`;
}

function resolveGroupCost(group, testMap){
  const cost = Number(group.cost);
  if (Number.isFinite(cost)) {
    return cost;
  }
  let sum = 0;
  (group.testIds || []).forEach(id => {
    const test = testMap.get(id);
    sum += Number(test?.cost) || 0;
  });
  return Math.round(sum * 100) / 100;
}

function hydratePatient(){
  const age = patient.age ? String(patient.age) : "";
  const gender = patient.gender || "";
  const ageSex =
    age && gender ? `${age} / ${gender}` : `${age}${gender}`;

  setText("pName", patient.name || "");
  setText("pDate", patient.visitDate || new Date().toLocaleDateString());
  setText("pAddress", patient.address || "");
  setText("pAgeSex", ageSex);
  setText("pDoctor", patient.doctor || "SELF");
  setText("pMobile", patient.mobile || "");
}

function loadSelectedTests(){
  if (!patient || !patient.id) {
    return Promise.resolve([]);
  }

  return fetch(`${API_BASE_URL}/patient-tests/${patient.id}`)
    .then(res => res.json())
    .then(list => (list || [])
      .map(x => Number(x.testId))
      .filter(id => !Number.isNaN(id)))
    .catch(() => {
      const stored =
        JSON.parse(localStorage.getItem("selectedTests") || "[]");
      return (stored || [])
        .map(id => Number(id))
        .filter(id => !Number.isNaN(id));
    });
}

function setTotals(subtotalValue, discountValue, totalValue){
  setText("subtotal", formatMoneyWithSymbol(subtotalValue));
  setText("discount", formatMoneyWithSymbol(discountValue));
  setText("total", formatMoneyWithSymbol(totalValue));
}

function renderBill(){
  const body = document.getElementById("billBody");

  if (!patient || !patient.id) {
    body.innerHTML = `<tr><td colspan="2">No patient selected</td></tr>`;
    setTotals(0, 0, 0);
    return;
  }

  loadSelectedTests()
    .then(ids => {
      const uniqueIds = [...new Set(ids)];
      if (!uniqueIds.length) {
        body.innerHTML = `<tr><td colspan="2">No tests found</td></tr>`;
        const amount = Number(patient.amount) || 0;
        setTotals(0, 0, amount);
        return;
      }

      return Promise.all([
        fetch(`${API_BASE_URL}/tests/active`).then(res => res.json()),
        fetch(`${API_BASE_URL}/groups`).then(res => res.json()).catch(() => [])
      ])
        .then(([tests, groups]) => {
          const testList = Array.isArray(tests) ? tests : [];
          const testMap = new Map(testList.map(t => [Number(t.id), t]));
          const selected =
            testList.filter(t => uniqueIds.includes(t.id));

          if (!selected.length) {
            body.innerHTML = `<tr><td colspan="2">No tests found</td></tr>`;
            const amount = Number(patient.amount) || 0;
            setTotals(0, 0, amount);
            return;
          }

          const normalizedGroups = (Array.isArray(groups) ? groups : [])
            .map(group => {
              const ids = Array.isArray(group.testIds) ? group.testIds : [];
              const testIds = ids
                .map(id => Number(id))
                .filter(id => Number.isFinite(id) && testMap.has(id));
              return { ...group, testIds };
            })
            .filter(group => group.testIds.length)
            .sort((a, b) => {
              const diff = b.testIds.length - a.testIds.length;
              if (diff !== 0) return diff;
              return (Number(a.id) || 0) - (Number(b.id) || 0);
            });

          const selectedSet = new Set(uniqueIds);
          const selectedGroups = [];
          const coveredTests = new Set();

          normalizedGroups.forEach(group => {
            const allSelected = group.testIds.every(id => selectedSet.has(id));
            if (!allSelected) {
              return;
            }
            const overlaps = group.testIds.some(id => coveredTests.has(id));
            if (overlaps) {
              return;
            }
            selectedGroups.push(group);
            group.testIds.forEach(id => coveredTests.add(id));
          });

          let subtotal = 0;
          body.innerHTML = "";

          selectedGroups.forEach(group => {
            const cost = resolveGroupCost(group, testMap);
            subtotal += cost;
            body.innerHTML += `
              <tr>
                <td>${group.groupName || "Group"} (Group)</td>
                <td class="amount">₹${formatMoney(cost)}</td>
              </tr>
            `;
          });

          selected
            .filter(test => !coveredTests.has(Number(test.id)))
            .forEach(test => {
              const cost = Number(test.cost) || 0;
              subtotal += cost;
              body.innerHTML += `
                <tr>
                  <td>${test.testName || "-"}</td>
                  <td class="amount">₹${formatMoney(cost)}</td>
                </tr>
              `;
            });

          const patientAmount = Number(patient.amount);
          const total = Number.isFinite(patientAmount)
            ? patientAmount
            : subtotal;
          const discount = Math.max(0, subtotal - total);

          setTotals(subtotal, discount, total);
        })
        .catch(() => {
          body.innerHTML = `<tr><td colspan="2">Failed to load tests</td></tr>`;
          const amount = Number(patient.amount) || 0;
          setTotals(0, 0, amount);
        });
    })
    .catch(() => {
      body.innerHTML = `<tr><td colspan="2">Failed to load tests</td></tr>`;
      const amount = Number(patient.amount) || 0;
      setTotals(0, 0, amount);
    });
}

function goPatients(){
  if (parent?.loadPage) {
    parent.loadPage("home/sub-tasks/2-patient.html", "patient");
  } else {
    location.href = "../2-patient.html";
  }
}

hydratePatient();
renderBill();
</script>
</body>
</html>
