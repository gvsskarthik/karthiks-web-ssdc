<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Select Tests</title>

<style>
body{
  margin:0;
  padding:20px;
  font-family:Poppins,Arial,sans-serif;
  background:#ecf0f3;
}

.neo-card{
  max-width:900px;
  margin:auto;
  padding:25px;
  border-radius:24px;
  background:#ecf0f3;
  box-shadow:10px 10px 20px #c5c9cc,
             -10px -10px 20px #ffffff;
}

.search{
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  margin-bottom:20px;
  background:#ecf0f3;
  box-shadow:inset 6px 6px 10px #c5c9cc,
             inset -6px -6px 10px #ffffff;
}

.group{
  margin-bottom:16px;
}

.level{
  margin-left:20px;
  margin-top:6px;
}

.row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0;
  font-weight:500;
}

.row input{ width:16px; height:16px }

.hidden{ display:none }

.neo-btn{
  margin-top:25px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:18px;
  background:#ecf0f3;
  box-shadow:6px 6px 12px #c5c9cc,
             -6px -6px 12px #ffffff;
  font-weight:600;
  cursor:pointer;
}
.neo-btn:active{
  box-shadow:inset 6px 6px 12px #c5c9cc,
             inset -6px -6px 12px #ffffff;
}

.no-result{
  text-align:center;
  color:#999;
  margin-top:20px;
}
</style>
  <link rel="stylesheet" href="../theme.css">
</head>

<body>

<div class="neo-card">
  <h2>Select Tests</h2>

  <input
    id="search"
    class="search"
    placeholder="Search by test name or shortcut (HB, TC...)"
    onkeyup="searchTest()"
  >

  <div id="tree"></div>

  <div id="noResult" class="no-result hidden">
    ‚ùå No test available
  </div>

  <button class="neo-btn" onclick="submitTests()">CONTINUE</button>
</div>

<script src="../../../api.js"></script>
<script>
let selected = new Set();
const tree = document.getElementById("tree");
const searchInput = document.getElementById("search");
const noResult = document.getElementById("noResult");

/* üîπ LOAD TESTS */
fetch(API_BASE_URL + "/tests/active")
.then(r => r.json())
.then(tests => {
  renderList(Array.isArray(tests) ? tests : []);
});

/* üîπ RENDER LIST */
function renderList(list){
  tree.innerHTML = "";

  const ordered = [...list].sort((a, b) => {
    const left = Number(a && a.id) || 0;
    const right = Number(b && b.id) || 0;
    return left - right;
  });

  ordered.forEach(test => {
    if (!test || test.id == null) {
      return;
    }
    const row = document.createElement("div");
    row.className = "row test-row";
    row.dataset.name = String(test.testName || "").toLowerCase();
    row.dataset.shortcut = String(test.shortcut || "").toLowerCase();
    const shortcut = test.shortcut ? ` (${test.shortcut})` : "";
    row.innerHTML = `
      <input type="checkbox" id="test-${test.id}" name="test-${test.id}" value="${test.id}"
             onchange="toggleTest(this)">
      ${test.testName || ""}${shortcut}
    `;
    tree.appendChild(row);
  });
}

/* üîπ SINGLE TEST */
function toggleTest(cb){
  const id = Number(cb.value);
  if(cb.checked) selected.add(id);
  else selected.delete(id);
}

/* üîπ SEARCH (NAME + SHORTCUT) */
function searchTest(){
  const q = searchInput.value.toLowerCase();
  let found = false;

  document.querySelectorAll(".test-row").forEach(row=>{
    const name = row.dataset.name;
    const sc = row.dataset.shortcut;

    if(!q || name.includes(q) || sc === q){
      row.classList.remove("hidden");
      if(sc === q){
        const cb = row.querySelector("input");
        cb.checked = true;
        selected.add(Number(cb.value));
      }
      found = true;
    } else {
      row.classList.add("hidden");
    }
  });

  noResult.classList.toggle("hidden", found || !q);
}

/* üîπ SUBMIT */
function submitTests(){
  if(!selected.size){
    alert("Select at least one test");
    return;
  }
  localStorage.setItem(
    "selectedTests",
    JSON.stringify([...selected])
  );
    parent.loadPage("home/sub-tasks/pt/enter-values.html");}
</script>
</body>
</html>
