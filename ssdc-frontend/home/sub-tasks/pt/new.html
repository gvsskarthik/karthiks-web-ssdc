<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Patient</title>
<style>
:root{
  --page-max:1200px;
  --radius-lg:22px;
  --radius-md:14px;
}
body{
  margin:0;
  padding:24px;
}
.page{
  max-width:var(--page-max);
  margin:0 auto;
  display:grid;
  gap:24px;
}
.wrapper{
  display:grid;
  grid-template-columns:minmax(0,1.15fr) minmax(0,0.85fr);
  gap:24px;
  align-items:start;
}
.wrapper-vertical{display:grid;gap:24px}
.neo-card{
  padding:22px;
  border-radius:var(--radius-lg);
  border:1px solid ;
}
h3{
  margin:0 0 16px;
  font-size:18px;
  letter-spacing:.3px;
}
.form-group{margin-bottom:14px}
label{
  font-size:12px;
  margin-bottom:6px;
  display:block;
  text-transform:uppercase;
  letter-spacing:.4px;
}
.neo-input,.neo-select,.search{
  width:100%;
  padding:10px 12px;
  border-radius:var(--radius-md);
  border:1px solid ;
  box-shadow:none;
  font-size:14px;
}
.neo-input:focus,
.neo-select:focus,
.search:focus{
  outline:none;
}
.row{display:flex;gap:16px;flex-wrap:wrap}
.row .form-group{flex:1;min-width:160px}
.neo-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 16px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
}
.action-bar{display:flex;justify-content:flex-end}
.action-bar .neo-btn{width:100%;max-width:340px}
#existingPatients{display:grid;gap:10px}
.patient-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:10px 12px;
  border-radius:var(--radius-md);
  border:1px solid ;
}
.patient-row b{font-size:14px}
.small-btn{
  padding:6px 12px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:600;
}
.small-btn:hover{}
.search{
  padding:12px 12px;
  margin-bottom:16px;
}
.search-wrap{position:relative}
.suggestions{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  margin-top:8px;
  border-radius:var(--radius-md);
  border:1px solid ;
  max-height:260px;
  overflow-y:auto;
  z-index:5;
}
.suggestion{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid ;
}
.suggestion:last-child{border-bottom:none}
.suggestion:hover,.suggestion.active{}
.suggestion-main{display:flex;flex-direction:column;gap:2px}
.suggestion-name{font-weight:600}
.suggestion-meta{font-size:12px;}
.suggestion-cost{font-weight:600}
.selected-tests{margin-top:12px;display:grid;gap:8px}
.selected-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:var(--radius-md);
  border:1px solid ;
}
.selected-item.group-item{
  font-weight:600;
}
.selected-item.group-test{
  margin-left:16px;
  border-style:dashed;
}
.selected-item.group-test .selected-cost{
  font-size:12px;
}
.selected-item label{
  display:flex;
  align-items:center;
  gap:8px;
  flex:1;
}
.selected-item input{width:16px;height:16px;accent-}
.selected-cost{font-weight:600;min-width:72px;text-align:right}
.bill-header{
  display:flex;
  justify-content:space-between;
  font-weight:700;
  margin-bottom:8px;
}
.bill-items{display:grid;gap:6px}
.bill-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 0;
  border-bottom:1px dashed ;
}
.bill-row:last-child{border-bottom:none}
.bill-name{flex:1}
.bill-amount{width:110px;text-align:right;font-weight:600}
.visually-hidden{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
.hidden{display:none}
.no-result{text-align:center;padding:10px 0}
@media (max-width:1020px){
  body{padding:18px}
  .wrapper{grid-template-columns:1fr}
}
@media (max-width:720px){
  body{padding:16px}
  .row{flex-direction:column}
  .action-bar{justify-content:stretch}
  .action-bar .neo-btn{max-width:none}
}
</style>
  <link rel="stylesheet" href="../theme.css">
</head>
<body>
<script src="../theme-init.js"></script>
<div class="page">
<div class="wrapper">
<div class="neo-card">
<h3>New Patient Registration</h3>
<form id="patientForm">
<div class="form-group">
<label for="visitDate">Date</label>
<input id="visitDate" type="date" class="neo-input">
</div>
<div class="form-group">
<label for="name">Name</label>
<input id="name" class="neo-input" autocomplete="name" required>
</div>
<div class="row">
<div class="form-group" style="flex: 1">
<label for="age">Age</label>
<input id="age" type="number" class="neo-input" required>
</div>
<div class="form-group" style="flex: 1">
<label for="gender">Sex</label>
<select id="gender" class="neo-select">
<option>Male</option>
<option>Female</option>
<option>Male child</option>
<option>Female child</option>
<option>Other</option>
</select>
</div>
</div>
<div class="form-group">
<label for="mobile">Mobile</label>
<input id="mobile" class="neo-input" autocomplete="tel" required>
</div>
<div class="form-group">
<label for="address">Address</label>
<input id="address" class="neo-input" autocomplete="street-address">
</div>
<div class="form-group">
<label for="doctor">Doctor Refer</label>
<select id="doctor" class="neo-select">
<option value="">SELF</option>
</select>
</div>
</form>
</div>
<div class="neo-card">
<h3>Existing Patient Data</h3>
<div id="existingPatients"></div>
</div>
</div>
<div class="wrapper-vertical">
<div class="neo-card">
<h3>Select Tests</h3>
<label class="visually-hidden" for="search">Search tests</label>
<div class="search-wrap">
  <input id="search" class="search" placeholder="Search test...">
  <div id="suggestions" class="suggestions hidden"></div>
</div>
<div id="noResult" class="no-result hidden">❌ No test available</div>
<div id="selectedTests" class="selected-tests"></div>
</div>
<div class="neo-card">
<h3>Bill</h3>
<div class="bill-header">
  <div>Test Name</div>
  <div class="bill-amount">Amount</div>
</div>
<div id="billItems" class="bill-items"></div>
<div class="row" style="margin-top: 12px">
  <div class="form-group" style="flex: 1">
    <label for="discount">Discount</label>
    <input id="discount" type="number" class="neo-input" min="0" step="0.01">
  </div>
  <div class="form-group" style="flex: 1">
    <label for="amount">Total</label>
    <input id="amount" type="number" class="neo-input" min="0" step="0.01">
  </div>
</div>
</div>
<div class="action-bar">
  <button class="neo-btn" type="button" id="savePatientBtn">
  SAVE PATIENT & ENTER RESULTS
  </button>
</div>
</div>
</div>
<script src="../../../api.js"></script>
<script>
/**
 * @typedef {{id:number,testName:string,shortcut?:string,cost?:number}} TestItem
 */
const patientForm = document.getElementById("patientForm");
const visitDate = document.getElementById("visitDate");
const doctor = document.getElementById("doctor");
const existingPatients = document.getElementById("existingPatients");
const selectedList = document.getElementById("selectedTests");
const noResult = document.getElementById("noResult");
const searchInput = document.getElementById("search");
const suggestions = document.getElementById("suggestions");
const savePatientBtn = document.getElementById("savePatientBtn");
visitDate.value = new Date().toISOString().split("T")[0];
let selected = new Set();
let testInfoMap = new Map();
let testOrderMap = new Map();
let testOrderCounter = 0;
let allTests = [];
let groups = [];
let groupMap = new Map();
let groupOrderMap = new Map();
let groupOrderCounter = 0;
let suggestionItems = [];
let activeSuggestionIndex = -1;
const existingList = [];
const nameInput = document.getElementById("name");
const mobileInput = document.getElementById("mobile");
const amountInput = document.getElementById("amount");
const discountInput = document.getElementById("discount");
const billItems = document.getElementById("billItems");
let lastBillEdited = null;
let isAutoBillUpdate = false;
let searchTimer = null;
searchInput.addEventListener("input", updateSuggestions);
searchInput.addEventListener("keydown", handleSuggestionKeys);
suggestions.addEventListener("click", handleSuggestionClick);
selectedList.addEventListener("change", handleSelectedChange);
savePatientBtn.addEventListener("click", () => patientForm.requestSubmit());
nameInput.addEventListener("input", () => {
  localStorage.removeItem("currentPatient");
  applyPatientFilter();
});
mobileInput.addEventListener("input", () => {
  localStorage.removeItem("currentPatient");
  applyPatientFilter();
});
discountInput.addEventListener("input", () => {
  if (isAutoBillUpdate) {
    return;
  }
  lastBillEdited = "discount";
  updateBillFromSelection();
});
amountInput.addEventListener("input", () => {
  if (isAutoBillUpdate) {
    return;
  }
  lastBillEdited = "total";
  updateBillFromSelection();
});
/* LOAD DOCTORS */
fetch(API_BASE_URL + "/doctors")
.then(r=>r.json())
.then(list => {
  const seen = new Set(["self"]);
  (list || []).forEach(x => {
    const name = String(x?.name || "").trim();
    if (!name) {
      return;
    }
    const key = name.toLowerCase();
    if (key === "self" || seen.has(key)) {
      return;
    }
    seen.add(key);
    doctor.innerHTML += `<option>${name}</option>`;
  });
});
/* LOAD EXISTING PATIENTS (DB SEARCH) */
applyPatientFilter();
function renderExistingPatients(list){
  existingPatients.innerHTML = "";
  if (!list.length) {
    existingPatients.innerHTML = `<div class="no-result">No matching patients</div>`;
    return;
  }
  list.forEach(p=>{
    existingPatients.innerHTML+=`
    <div class="patient-row">
      <div><b>${p.name}</b><br>${p.mobile}</div>
      <button class="small-btn" onclick='selectPatient(${JSON.stringify(p)})'>SELECT</button>
    </div>`;
  });
}
function applyPatientFilter(){
  const nameQuery = nameInput.value.trim();
  const mobileQuery = normalizeDigits(mobileInput.value.trim());
  if (searchTimer) {
    clearTimeout(searchTimer);
  }
  searchTimer = setTimeout(() => {
    const params = new URLSearchParams();
    params.set("name", nameQuery);
    params.set("mobile", mobileQuery);
    fetch(`${API_BASE_URL}/patients/search?${params.toString()}`)
    .then(r=>r.json())
    .then(list=>{
      existingList.splice(0, existingList.length, ...list);
      renderExistingPatients(list);
    });
  }, 250);
}
function normalizeDigits(value){
  return String(value || "").replace(/\D/g, "");
}
function parseMoney(value){
  const num = Number(value);
  return Number.isFinite(num) ? num : 0;
}
function formatMoney(value){
  return String(Math.round(value * 100) / 100);
}
function resolveGroupCost(group){
  const cost = Number(group.cost);
  if (Number.isFinite(cost)) {
    return cost;
  }
  let sum = 0;
  (group.testIds || []).forEach(id => {
    const testInfo = testInfoMap.get(id);
    sum += Number(testInfo?.cost) || 0;
  });
  return Math.round(sum * 100) / 100;
}
function deriveGroupSelection(){
  const ordered = [...groupMap.values()]
    .filter(group => Array.isArray(group.testIds) && group.testIds.length)
    .sort((a, b) => {
      const diff = b.testIds.length - a.testIds.length;
      if (diff !== 0) return diff;
      const orderA = groupOrderMap.has(a.id) ? groupOrderMap.get(a.id) : 0;
      const orderB = groupOrderMap.has(b.id) ? groupOrderMap.get(b.id) : 0;
      return orderA - orderB;
    });
  const selectedGroups = [];
  const coveredTests = new Set();
  ordered.forEach(group => {
    const ids = group.testIds || [];
    const allSelected = ids.every(id => selected.has(id));
    if (!allSelected) {
      return;
    }
    const overlaps = ids.some(id => coveredTests.has(id));
    if (overlaps) {
      return;
    }
    selectedGroups.push(group);
    ids.forEach(id => coveredTests.add(id));
  });
  return { selectedGroups, coveredTests };
}
function setInputValue(input, value){
  isAutoBillUpdate = true;
  input.value = value;
  isAutoBillUpdate = false;
}
function buildBillLines(){
  const lines = [];
  let baseTotal = 0;
  const { selectedGroups, coveredTests } = deriveGroupSelection();
  const groupRows = selectedGroups
    .slice()
    .sort((a, b) => {
      const orderA = groupOrderMap.has(a.id)
        ? groupOrderMap.get(a.id)
        : Number.MAX_SAFE_INTEGER;
      const orderB = groupOrderMap.has(b.id)
        ? groupOrderMap.get(b.id)
        : Number.MAX_SAFE_INTEGER;
      if (orderA !== orderB) {
        return orderA - orderB;
      }
      return String(a.groupName || "").localeCompare(String(b.groupName || ""));
    });
  groupRows.forEach(group => {
    const cost = resolveGroupCost(group);
    lines.push({ label: `${group.groupName || "Group"} (Group)`, cost });
    baseTotal += cost;
  });
  const rows = [...selected]
    .filter(id => !coveredTests.has(id))
    .map(id => ({ id, ...(testInfoMap.get(id) || {}) }))
    .filter(item => item && item.name)
    .sort((a, b) => {
      const orderA = testOrderMap.has(a.id)
        ? testOrderMap.get(a.id)
        : Number.MAX_SAFE_INTEGER;
      const orderB = testOrderMap.has(b.id)
        ? testOrderMap.get(b.id)
        : Number.MAX_SAFE_INTEGER;
      if (orderA !== orderB) {
        return orderA - orderB;
      }
      return a.name.localeCompare(b.name);
    });
  rows.forEach(item => {
    const cost = Number(item.cost) || 0;
    lines.push({ label: item.name, cost });
    baseTotal += cost;
  });
  return { lines, baseTotal: Math.round(baseTotal * 100) / 100 };
}
function renderBillItems(){
  billItems.innerHTML = "";
  if (!selected.size) {
    billItems.innerHTML = `<div class="no-result">No tests selected</div>`;
    return 0;
  }
  const { lines, baseTotal } = buildBillLines();
  if (!lines.length) {
    billItems.innerHTML = `<div class="no-result">No tests selected</div>`;
    return 0;
  }
  lines.forEach(line => {
    billItems.innerHTML += `
      <div class="bill-row">
        <div class="bill-name">${line.label}</div>
        <div class="bill-amount">₹${formatMoney(Number(line.cost) || 0)}</div>
      </div>
    `;
  });
  return baseTotal;
}
function syncBillTotals(baseTotal){
  let discount = parseMoney(discountInput.value);
  let total = parseMoney(amountInput.value);
  if (lastBillEdited === "discount") {
    total = baseTotal - discount;
  } else if (lastBillEdited === "total") {
    discount = baseTotal - total;
  } else {
    discount = 0;
    total = baseTotal;
  }
  setInputValue(discountInput, formatMoney(discount));
  setInputValue(amountInput, formatMoney(total));
}
function updateBillFromSelection(){
  const baseTotal = renderBillItems();
  syncBillTotals(baseTotal);
}
/* ✅ FIXED */
function selectPatient(p){
  document.getElementById("name").value    = p.name || "";
  document.getElementById("age").value     = p.age || "";
  document.getElementById("gender").value  = p.gender || "Male";
  document.getElementById("mobile").value  = p.mobile || "";
  document.getElementById("address").value = p.address || "";
  document.getElementById("doctor").value  = p.doctor || "SELF";
  lastBillEdited = null;
  setInputValue(discountInput, "");
  setInputValue(amountInput, "");
  updateBillFromSelection();
  // Prefill only; keep visits separate
  localStorage.setItem("prefillPatient", JSON.stringify(p));
  localStorage.removeItem("currentPatient");
  localStorage.removeItem("patientResults");
  localStorage.removeItem("selectedTests");
  applyPatientFilter();
}
/* TEST LIST */
Promise.all([
  fetch(API_BASE_URL + "/tests/active").then(r => r.json()),
  fetch(API_BASE_URL + "/groups").then(r => r.json()).catch(() => [])
])
.then(([testList, groupList]) => initTests(testList, groupList));
/** @param {TestItem[]} list */
function initTests(list, groupList){
  const tests = (Array.isArray(list) ? list : [])
    .filter(test => test && test.active !== false);
  const incomingGroups = Array.isArray(groupList) ? groupList : [];
  const ordered = [...tests].sort((a, b) => {
    const left = Number(a && a.id) || 0;
    const right = Number(b && b.id) || 0;
    return left - right;
  });
  allTests = ordered;
  testInfoMap = new Map();
  testOrderMap = new Map();
  testOrderCounter = 0;
  groups = incomingGroups;
  groupMap = new Map();
  groupOrderMap = new Map();
  groupOrderCounter = 0;
  ordered.forEach(test => {
    if (!test || test.id == null) {
      return;
    }
    const name = test.testName || "";
    const shortcut = test.shortcut || "";
    testInfoMap.set(test.id, {
      name,
      shortcut,
      cost: Number(test.cost) || 0
    });
    if (!testOrderMap.has(test.id)) {
      testOrderMap.set(test.id, testOrderCounter++);
    }
  });
  groups
    .filter(group => group && group.active !== false)
    .map(group => {
      const ids = Array.isArray(group.testIds) ? group.testIds : [];
      const testIds = ids
        .map(id => Number(id))
        .filter(id => Number.isFinite(id) && testInfoMap.has(id));
      return { ...group, testIds };
    })
    .forEach(group => {
      const groupId = Number(group?.id);
      if (!Number.isFinite(groupId)) {
        return;
      }
      const normalized = { ...group, id: groupId };
      groupMap.set(groupId, normalized);
      groupOrderMap.set(groupId, groupOrderCounter++);
    });
  renderSelectedList();
  updateBillFromSelection();
  updateSuggestions();
}
/* ================= LOGIC ================= */
function addSelectedTest(id){
  if (!testInfoMap.has(id)) {
    return;
  }
  if (selected.has(id)) {
    return;
  }
  selected.add(id);
  renderSelectedList();
  updateBillFromSelection();
}
function addSelectedGroup(groupId){
  const group = groupMap.get(groupId);
  if (!group || !Array.isArray(group.testIds)) {
    return;
  }
  group.testIds.forEach(id => {
    if (testInfoMap.has(id)) {
      selected.add(id);
    }
  });
  renderSelectedList();
  updateBillFromSelection();
  updateSuggestions();
}
function removeSelectedTest(id){
  if (!selected.has(id)) {
    return;
  }
  selected.delete(id);
  renderSelectedList();
  updateBillFromSelection();
  updateSuggestions();
}
function renderSelectedList(){
  selectedList.innerHTML = "";
  if (!selected.size) {
    selectedList.innerHTML = `<div class="no-result">No tests selected</div>`;
    return;
  }
  const { selectedGroups, coveredTests } = deriveGroupSelection();
  const groupRows = selectedGroups
    .slice()
    .sort((a, b) => {
      const orderA = groupOrderMap.has(a.id)
        ? groupOrderMap.get(a.id)
        : Number.MAX_SAFE_INTEGER;
      const orderB = groupOrderMap.has(b.id)
        ? groupOrderMap.get(b.id)
        : Number.MAX_SAFE_INTEGER;
      if (orderA !== orderB) {
        return orderA - orderB;
      }
      return String(a.groupName || "").localeCompare(String(b.groupName || ""));
    });
  const testRows = [...selected]
    .filter(id => !coveredTests.has(id))
    .map(id => ({ id, ...(testInfoMap.get(id) || {}) }))
    .filter(item => item && item.name)
    .sort((a, b) => {
      const orderA = testOrderMap.has(a.id)
        ? testOrderMap.get(a.id)
        : Number.MAX_SAFE_INTEGER;
      const orderB = testOrderMap.has(b.id)
        ? testOrderMap.get(b.id)
        : Number.MAX_SAFE_INTEGER;
      if (orderA !== orderB) {
        return orderA - orderB;
      }
      return a.name.localeCompare(b.name);
    });
  if (!groupRows.length && !testRows.length) {
    selectedList.innerHTML = `<div class="no-result">No tests selected</div>`;
    return;
  }
  groupRows.forEach(group => {
    const shortcutText = group.shortcut ? ` (${group.shortcut})` : "";
    const cost = resolveGroupCost(group);
    selectedList.innerHTML += `
      <div class="selected-item group-item">
        <label>
          <input class="selected-checkbox" data-type="group" type="checkbox" checked value="${group.id}">
          ${group.groupName || "Group"}${shortcutText}
        </label>
        <div class="selected-cost">₹${formatMoney(cost)}</div>
      </div>
    `;
    (group.testIds || [])
      .map(id => ({ id, ...(testInfoMap.get(id) || {}) }))
      .filter(item => item && item.name)
      .forEach(item => {
        const itemShortcut = item.shortcut ? ` (${item.shortcut})` : "";
        selectedList.innerHTML += `
          <div class="selected-item group-test">
            <label>
              <input class="selected-checkbox" data-type="test" type="checkbox" checked value="${item.id}">
              ${item.name}${itemShortcut}
            </label>
            <div class="selected-cost">₹${formatMoney(Number(item.cost) || 0)}</div>
          </div>
        `;
      });
  });
  testRows.forEach(item => {
    const shortcut = item.shortcut ? ` (${item.shortcut})` : "";
    selectedList.innerHTML += `
      <div class="selected-item">
        <label>
          <input class="selected-checkbox" data-type="test" type="checkbox" checked value="${item.id}">
          ${item.name}${shortcut}
        </label>
        <div class="selected-cost">₹${formatMoney(Number(item.cost) || 0)}</div>
      </div>
    `;
  });
}
function handleSelectedChange(event){
  const target = event.target;
  if (!target.classList.contains("selected-checkbox")) {
    return;
  }
  if (!target.checked) {
    const type = target.dataset.type || "test";
    const id = Number(target.value);
    if (type === "group") {
      const group = groupMap.get(id);
      if (group && Array.isArray(group.testIds)) {
        group.testIds.forEach(testId => selected.delete(testId));
      }
      renderSelectedList();
      updateBillFromSelection();
      updateSuggestions();
      return;
    }
    removeSelectedTest(id);
  }
}
function normalizeQuery(value){
  return String(value || "").trim().toLowerCase();
}
function rankSuggestion(test, query){
  const name = normalizeQuery(test.testName);
  const shortcut = normalizeQuery(test.shortcut);
  if (shortcut && shortcut.startsWith(query)) {
    return 0;
  }
  if (name.startsWith(query)) {
    return 1;
  }
  if (shortcut && shortcut.includes(query)) {
    return 2;
  }
  return 3;
}
function rankGroupSuggestion(group, query){
  const name = normalizeQuery(group.groupName);
  const shortcut = normalizeQuery(group.shortcut);
  if (shortcut && shortcut.startsWith(query)) {
    return 0;
  }
  if (name.startsWith(query)) {
    return 1;
  }
  if (shortcut && shortcut.includes(query)) {
    return 2;
  }
  return 3;
}
function groupMatchesQuery(group, query){
  const name = normalizeQuery(group.groupName);
  const shortcut = normalizeQuery(group.shortcut);
  if (name.includes(query) || shortcut.includes(query)) {
    return true;
  }
  return (group.testIds || []).some(id => {
    const test = testInfoMap.get(id);
    const testName = normalizeQuery(test?.name);
    const testShortcut = normalizeQuery(test?.shortcut);
    return testName.includes(query) || testShortcut.includes(query);
  });
}
function updateSuggestions(){
  const query = normalizeQuery(searchInput.value);
  if (!query) {
    suggestionItems = [];
    activeSuggestionIndex = -1;
    suggestions.innerHTML = "";
    suggestions.classList.add("hidden");
    noResult.classList.add("hidden");
    return;
  }
  const { selectedGroups } = deriveGroupSelection();
  const selectedGroupIds = new Set(selectedGroups.map(group => group.id));
  const groupMatches = [...groupMap.values()].filter(group => {
    if (selectedGroupIds.has(group.id)) {
      return false;
    }
    if (!Array.isArray(group.testIds) || !group.testIds.length) {
      return false;
    }
    return groupMatchesQuery(group, query);
  });
  const testMatches = allTests.filter(test => {
    if (!test || test.id == null) {
      return false;
    }
    if (selected.has(test.id)) {
      return false;
    }
    const name = normalizeQuery(test.testName);
    const shortcut = normalizeQuery(test.shortcut);
    return name.includes(query) || shortcut.includes(query);
  });
  const combined = [
    ...groupMatches.map(group => ({
      type: "group",
      id: group.id,
      name: group.groupName || "",
      shortcut: group.shortcut || "",
      cost: resolveGroupCost(group),
      rank: rankGroupSuggestion(group, query)
    })),
    ...testMatches.map(test => ({
      type: "test",
      id: test.id,
      name: test.testName || "",
      shortcut: test.shortcut || "",
      cost: Number(test.cost) || 0,
      rank: rankSuggestion(test, query)
    }))
  ];
  combined.sort((a, b) => {
    const rankDiff = a.rank - b.rank;
    if (rankDiff !== 0) {
      return rankDiff;
    }
    return (Number(a.id) || 0) - (Number(b.id) || 0);
  });
  suggestionItems = combined.slice(0, 8);
  activeSuggestionIndex = suggestionItems.length ? 0 : -1;
  suggestions.innerHTML = "";
  suggestionItems.forEach((item, index) => {
    const shortcut = item.shortcut ? item.shortcut : "";
    const price = formatMoney(Number(item.cost) || 0);
    const activeClass = index === activeSuggestionIndex ? " active" : "";
    const meta = item.type === "group"
      ? `Group${shortcut ? " · " + shortcut : ""}`
      : shortcut;
    suggestions.innerHTML += `
      <div class="suggestion${activeClass}" data-id="${item.id}" data-type="${item.type}">
        <div class="suggestion-main">
          <div class="suggestion-name">${item.name || ""}</div>
          <div class="suggestion-meta">${meta}</div>
        </div>
        <div class="suggestion-cost">₹${price}</div>
      </div>
    `;
  });
  suggestions.classList.toggle("hidden", !suggestionItems.length);
  noResult.classList.toggle("hidden", suggestionItems.length > 0);
}
function setActiveSuggestion(index){
  if (!suggestionItems.length) {
    activeSuggestionIndex = -1;
    return;
  }
  if (index < 0) {
    activeSuggestionIndex = suggestionItems.length - 1;
  } else if (index >= suggestionItems.length) {
    activeSuggestionIndex = 0;
  } else {
    activeSuggestionIndex = index;
  }
  const items = suggestions.querySelectorAll(".suggestion");
  items.forEach((item, idx) => {
    item.classList.toggle("active", idx === activeSuggestionIndex);
  });
}
function chooseSuggestion(type, id){
  const numericId = Number(id);
  if (!numericId) {
    return;
  }
  if (type === "group") {
    addSelectedGroup(numericId);
  } else {
    addSelectedTest(numericId);
  }
  searchInput.value = "";
  updateSuggestions();
  searchInput.focus();
}
function handleSuggestionClick(event){
  const item = event.target.closest(".suggestion");
  if (!item) {
    return;
  }
  const type = item.dataset.type || "test";
  chooseSuggestion(type, item.dataset.id);
}
function handleSuggestionKeys(event){
  if (event.key === "ArrowDown") {
    if (suggestionItems.length) {
      event.preventDefault();
      setActiveSuggestion(activeSuggestionIndex + 1);
    }
    return;
  }
  if (event.key === "ArrowUp") {
    if (suggestionItems.length) {
      event.preventDefault();
      setActiveSuggestion(activeSuggestionIndex - 1);
    }
    return;
  }
  if (event.key === "Enter") {
    if (suggestionItems.length) {
      event.preventDefault();
      const active = suggestionItems[activeSuggestionIndex] || suggestionItems[0];
      if (active) {
        chooseSuggestion(active.type, active.id);
      }
    }
    return;
  }
  if (event.key === "Escape") {
    suggestions.classList.add("hidden");
    noResult.classList.add("hidden");
  }
}
/* SUBMIT */
patientForm.addEventListener("submit", e => {
  e.preventDefault();
  if (!selected.size) {
    alert("Select at least one test");
    return;
  }
  const current =
    JSON.parse(localStorage.getItem("currentPatient") || "null");
  localStorage.removeItem("prefillPatient");
  const payload = {
    name: document.getElementById("name").value.trim(),
    age: Number(document.getElementById("age").value),
    gender: document.getElementById("gender").value,
    mobile: document.getElementById("mobile").value.trim(),
    address: document.getElementById("address").value.trim(),
    doctor: document.getElementById("doctor").value || "SELF",
    visitDate: document.getElementById("visitDate").value,
    amount: parseMoney(amountInput.value),
    discount: parseMoney(discountInput.value),
    status: "NOT COMPLETE"
  };
  // ✅ EXISTING PATIENT → no save
  if (current && current.id) {
    localStorage.setItem("selectedTests", JSON.stringify([...selected]));
    parent.loadPage("home/sub-tasks/pt/enter-values.html");
    return;
  }
  // ✅ NEW PATIENT → save
  fetch(API_BASE_URL + "/patients", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(p => {
    localStorage.setItem("currentPatient", JSON.stringify(p));
    localStorage.setItem("selectedTests", JSON.stringify([...selected]));
    parent.loadPage("home/sub-tasks/pt/enter-values.html");
  })
  .catch(err => {
    console.error(err);
    alert("Failed to save patient");
  });
});
</script>
</body>
</html>