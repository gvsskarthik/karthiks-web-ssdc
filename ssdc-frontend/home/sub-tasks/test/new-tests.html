<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Test</title>

<style>
:root{
  --radius-lg:22px;
  --radius-md:14px;
  --radius-sm:10px;
}
*{
  box-sizing:border-box;
}
body{
  margin:0;
  padding:24px;
  font-family:"Poppins","Lato",sans-serif;
  color:var(--theme-ink);
  background:transparent;
  min-height:100vh;
}
.neo-card{
  max-width:1200px;
  margin:0 auto;
  padding:26px;
  border-radius:var(--radius-lg);
  background:var(--theme-surface);
  border:1px solid var(--theme-line);
  box-shadow:var(--theme-shadow);
  display:grid;
  gap:18px;
}

h2{
  margin:0;
  font-size:24px;
  letter-spacing:.3px;
}

label{
  font-size:12px;
  text-transform:uppercase;
  color:var(--theme-muted);
  font-weight:600;
  display:block;
  margin-bottom:6px;
  letter-spacing:.4px;
}

input, textarea, select{
  width:100%;
  padding:10px 12px;
  border-radius:var(--radius-md);
  border:1px solid var(--theme-line);
  background:#fff;
  font-size:14px;
  color:var(--theme-ink);
}

input:focus,
textarea:focus,
select:focus{
  outline:none;
  border-color:var(--theme-accent);
  box-shadow:0 0 0 3px rgba(15, 118, 110, 0.12);
}

textarea{
  resize:vertical;
}

input[type="checkbox"]{
  width:auto;
  padding:0;
  box-shadow:none;
  accent-color:var(--theme-accent);
}

.grid-2{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:16px;
}

.grid-3{
  display:grid;
  grid-template-columns:1.6fr 1fr 1fr;
  gap:12px;
}

.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding-top:6px;
  border-top:1px dashed var(--theme-line);
}

.section-header h3{
  margin:0;
  font-size:16px;
}

.param-card{
  margin-top:12px;
  padding:16px;
  border-radius:var(--radius-md);
  background:var(--theme-surface-2);
  border:1px solid var(--theme-line);
  box-shadow:none;
}

.param-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.param-title{
  margin:0;
  font-size:15px;
}

.section-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed var(--theme-line);
}

.section-row h4{
  margin:0;
  font-size:12px;
  color:var(--theme-muted);
  text-transform:uppercase;
  letter-spacing:.4px;
}

.normal-row{
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
  align-items:center;
  margin-top:10px;
}

.hidden{
  display:none;
}

.row-error{
  grid-column:1 / -1;
  color:var(--theme-danger);
  font-size:12px;
}

.actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin-top:12px;
  flex-wrap:wrap;
}

.btn{
  padding:10px 16px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg, var(--theme-accent), #1aa191);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 12px 24px rgba(15, 118, 110, 0.18);
}

.btn.small{
  padding:8px 12px;
  font-size:12px;
}

.btn.link{
  padding:6px 10px;
  font-size:12px;
  color:var(--theme-danger);
  background:transparent;
  box-shadow:none;
}

.message{
  margin-top:6px;
  font-size:13px;
  color:var(--theme-muted);
}

.message.error{
  color:var(--theme-danger);
}

.message.success{
  color:#1b7a3f;
}

.field-msg{
  margin-top:6px;
  font-size:12px;
  color:var(--theme-danger);
  min-height:14px;
}

.inline{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:4px;
  padding:8px 10px;
  border-radius:999px;
  background:var(--theme-surface-2);
  border:1px solid var(--theme-line);
  width:fit-content;
}

.error{
  border-color:#e74c3c;
  box-shadow:0 0 0 2px rgba(231, 76, 60, 0.25);
}

.grid-2 > div,
.grid-3 > div,
.normal-row > *{
  min-width:0;
}

@media (max-width:980px){
  .grid-3{
    grid-template-columns:1fr 1fr;
  }

  .normal-row{
    grid-template-columns:1fr;
  }
}
@media (max-width:640px){
  body{padding:16px;}
  .grid-2,
  .grid-3{
    grid-template-columns:1fr;
  }
}
</style>
  <link rel="stylesheet" href="../theme.css">
</head>

<body>
<script src="../theme-init.js"></script>

<div class="neo-card">
  <h2>New Test</h2>

  <div class="grid-2">
    <div>
      <label for="testName">Test Name</label>
      <input id="testName" placeholder="Test Name">
    </div>
    <div>
      <label for="shortcut">Shortcut</label>
      <input id="shortcut" placeholder="Shortcut">
      <div id="shortcutMsg" class="field-msg"></div>
    </div>
    <div>
      <label for="category">Category</label>
      <select id="category">
        <option value="">Select category</option>
        <option>Biochemistry</option>
        <option>Hematology</option>
        <option>Serology</option>
        <option>Immunology</option>
        <option>Microbiology</option>
      </select>
    </div>
    <div>
      <label for="cost">Cost</label>
      <input id="cost" type="number" step="0.01" placeholder="Cost">
    </div>
  </div>

  <div class="inline">
    <input id="active" type="checkbox" checked>
    <label for="active" style="margin:0;">Active</label>
  </div>

  <div class="section-header">
    <h3>Parameters</h3>
    <button class="btn small" type="button" id="addParamBtn">Add Parameter</button>
  </div>

  <div id="paramList"></div>

  <div class="actions">
    <button class="btn" type="button" id="saveBtn">Save Test</button>
  </div>
  <div id="formMessage" class="message"></div>
</div>

<script src="../../../api.js"></script>
<script>
const paramList = document.getElementById("paramList");
const addParamBtn = document.getElementById("addParamBtn");
const saveBtn = document.getElementById("saveBtn");
const formMessage = document.getElementById("formMessage");
const shortcutInput = document.getElementById("shortcut");
const shortcutMsg = document.getElementById("shortcutMsg");

let shortcutsLoaded = false;
let existingShortcuts = new Set();
let paramIdCounter = 0;
let normalIdCounter = 0;

addParamBtn.addEventListener("click", () => addParameter());
saveBtn.addEventListener("click", () => saveTest());
shortcutInput.addEventListener("input", () => validateShortcut());
shortcutInput.addEventListener("blur", () => validateShortcut());

function addParameter() {
  const card = document.createElement("div");
  card.className = "param-card";
  const paramId = `param-${paramIdCounter++}`;
  const nameId = `${paramId}-name`;
  const unitId = `${paramId}-unit`;
  const typeId = `${paramId}-type`;
  card.innerHTML = `
    <div class="param-header">
      <h4 class="param-title">Parameter</h4>
      <button class="btn link remove-param" type="button">Remove</button>
    </div>
    <div class="grid-3">
      <div>
        <label for="${nameId}">Parameter Name</label>
        <input id="${nameId}" type="text" class="param-name" placeholder="Parameter Name">
      </div>
      <div>
        <label for="${unitId}">Unit</label>
        <input id="${unitId}" type="text" class="param-unit" placeholder="Unit">
      </div>
      <div>
        <label for="${typeId}">Value Type</label>
        <select id="${typeId}" class="param-type">
          <option value="">Select value type</option>
          <option value="NUMBER">NUMBER</option>
          <option value="TEXT">TEXT</option>
        </select>
      </div>
    </div>
    <div class="section-row normal-section">
      <h4>Normal Ranges</h4>
      <button class="btn small add-normal" type="button">Add Normal</button>
    </div>
    <div class="normals"></div>
  `;

  paramList.appendChild(card);
  card.querySelector(".remove-param").addEventListener("click", () => {
    card.remove();
    refreshParameterLabels();
  });
  card.querySelector(".add-normal").addEventListener("click", () => {
    addNormalRow(card.querySelector(".normals"));
  });

  addNormalRow(card.querySelector(".normals"));
  refreshParameterLabels();
}

function addNormalRow(container) {
  const row = document.createElement("div");
  row.className = "normal-row";
  const normalId = `normal-${normalIdCounter++}`;
  row.innerHTML = `
    <input id="${normalId}" name="${normalId}" type="text" class="normal-text" placeholder="Normal value (e.g. [Male : 14.0 - 16.0 gms])">
    <button class="btn link remove-normal" type="button">Remove</button>
    <div class="row-error"></div>
  `;
  container.appendChild(row);
  row.querySelector(".remove-normal").addEventListener("click", () => row.remove());
}

function refreshParameterLabels() {
  const cards = [...document.querySelectorAll(".param-card")];
  cards.forEach((card, index) => {
    const title = card.querySelector(".param-title");
    title.textContent = "Parameter " + (index + 1);
  });
}

function setMessage(text, type) {
  formMessage.textContent = text || "";
  formMessage.className = "message" + (type ? " " + type : "");
}

function clearErrors() {
  document.querySelectorAll(".error").forEach(el => el.classList.remove("error"));
  document.querySelectorAll(".row-error").forEach(el => el.textContent = "");
}

function normalizeShortcut(value) {
  return (value || "").trim().toLowerCase();
}

async function loadShortcuts() {
  try {
    const res = await fetch(API_BASE_URL + "/tests");
    if (!res.ok) {
      return;
    }
    const list = await res.json();
    existingShortcuts = new Set(
      (list || [])
        .map(t => normalizeShortcut(t.shortcut))
        .filter(Boolean)
    );
    shortcutsLoaded = true;
    validateShortcut();
  } catch (err) {
    console.error(err);
  }
}

function validateShortcut() {
  const value = shortcutInput.value;
  const normalized = normalizeShortcut(value);

  if (!normalized) {
    shortcutMsg.textContent = "";
    shortcutInput.classList.remove("error");
    return false;
  }

  if (shortcutsLoaded && existingShortcuts.has(normalized)) {
    shortcutMsg.textContent = "Shortcut already exists.";
    shortcutInput.classList.add("error");
    return true;
  }

  shortcutMsg.textContent = "";
  shortcutInput.classList.remove("error");
  return false;
}

function normalizeNormalText(value) {
  return (value || "").trim();
}

function collectPayload() {
  clearErrors();
  const errors = [];

  const testName = document.getElementById("testName");
  const shortcut = document.getElementById("shortcut");
  const category = document.getElementById("category");
  const cost = document.getElementById("cost");
  const active = document.getElementById("active");

  if (!testName.value.trim()) {
    testName.classList.add("error");
    errors.push("Test name is required.");
  }
  if (!shortcut.value.trim()) {
    shortcut.classList.add("error");
    errors.push("Shortcut is required.");
  }
  if (validateShortcut()) {
    errors.push("Shortcut already exists.");
  }
  if (!category.value.trim()) {
    category.classList.add("error");
    errors.push("Category is required.");
  }

  const costRaw = cost.value.trim();
  let costValue = null;
  if (!costRaw) {
    cost.classList.add("error");
    errors.push("Cost is required.");
  } else {
    costValue = Number(costRaw);
    if (Number.isNaN(costValue)) {
      cost.classList.add("error");
      errors.push("Cost must be a number.");
    }
  }

  const parameters = [];
  const cards = [...document.querySelectorAll(".param-card")];

  if (cards.length === 0) {
    errors.push("Add at least one parameter.");
  }

  cards.forEach((card, index) => {
    const nameInput = card.querySelector(".param-name");
    const unitInput = card.querySelector(".param-unit");
    const typeSelect = card.querySelector(".param-type");

    const name = nameInput.value.trim();
    if (!typeSelect.value) {
      typeSelect.classList.add("error");
      errors.push("Value type is required.");
      return;
    }

    const normals = [];
    const normalRows = [...card.querySelectorAll(".normal-row")];

    normalRows.forEach(row => {
      const textValueRaw = normalizeNormalText(
        row.querySelector(".normal-text").value
      );
      if (!textValueRaw) {
        return;
      }

      normals.push({
        textValue: textValueRaw
      });
    });

    parameters.push({
      name: name || `Parameter ${index + 1}`,
      unit: unitInput.value.trim() || null,
      valueType: typeSelect.value,
      normalRanges: normals
    });
  });

  if (errors.length) {
    setMessage("Please fix the highlighted errors.", "error");
    return null;
  }

  return {
    testName: testName.value.trim(),
    shortcut: shortcut.value.trim(),
    category: category.value.trim(),
    cost: costValue,
    active: active.checked,
    parameters: parameters
  };
}

async function saveTest() {
  const payload = collectPayload();
  if (!payload) {
    return;
  }

  setMessage("Saving...", "");
  saveBtn.disabled = true;

  try {
    const res = await fetch(API_BASE_URL + "/tests", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errText = await res.text();
      setMessage(errText || "Save failed.", "error");
      saveBtn.disabled = false;
      return;
    }

    setMessage("Saved successfully.", "success");
    setTimeout(() => {
      window.location.href = "../5-tests.html";
    }, 600);
  } catch (err) {
    console.error(err);
    setMessage("Backend not running or network error.", "error");
  } finally {
    saveBtn.disabled = false;
  }
}

addParameter();
loadShortcuts();
</script>

</body>
</html>
