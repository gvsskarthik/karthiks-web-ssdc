<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patients</title>
<link href="../../vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
<style>
:root{
  --radius-lg:22px;
  --radius-md:14px;
}
body{
  margin:0;
  padding:24px;
  min-height:100vh;
}
.page{
  max-width:1200px;
  margin:0 auto;
  display:grid;
  gap:18px;
}
.head-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:18px;
  animation:fadeUp .45s ease both;
}
.head-title h1{
  font-size:32px;
  font-weight:700;
  margin:0;
  letter-spacing:.3px;
}
.subtitle{
  font-size:12px;
  margin-top:4px;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.neo-btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:999px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}
.neo-btn:hover{transform:translateY(-1px)}
.neo-btn:active{transform:translateY(1px)}
.neo-btn.secondary{
  border:1px solid ;
}
.filters{
  display:grid;
  grid-template-columns:220px minmax(0,1fr);
  gap:16px;
  align-items:end;
  width:100%;
  max-width:560px;
  animation:fadeUp .5s ease both;
}
.filter-group{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.filter-group label{
  font-size:12px;
  letter-spacing:.4px;
  text-transform:uppercase;
}
.input-wrap{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 12px;
  border-radius:var(--radius-md);
  border:1px solid ;
}
.input-wrap i{
  font-size:18px;
}
.icon-btn{
  border:none;
  padding:0;
  margin:0;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:color .15s ease;
}
.icon-btn:hover{
}
.icon-btn:focus-visible{
  outline:2px solid rgba(15, 118, 110, 0.35);
  outline-offset:2px;
  border-radius:8px;
}
.neo-input{
  flex:1;
  border:none;
  outline:none;
  font-size:14px;
  min-width:0;
}
.bulk-bar{
  display:none;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  border-radius:var(--radius-md);
  border:1px solid ;
  animation:fadeUp .45s ease both;
}
.bulk-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.table-box{
  border-radius:var(--radius-lg);
  padding:16px;
  animation:fadeUp .55s ease both;
}
.page .table-wrap{overflow-x:visible}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 10px;
  table-layout:fixed;
}
.page .table-wrap table{
  min-width:0;
}
thead th{
  text-align:left;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.6px;
  padding:0 12px 6px;
}
tbody tr{
  transition:transform .15s ease, box-shadow .15s ease;
}
tbody tr:hover{
  transform:translateY(-1px);
}
body.menu-open tbody tr:hover{
  transform:none;
  box-shadow:none;
}
tbody tr.menu-open{
  position:relative;
  z-index:2;
}
tbody td{
  padding:12px;
  border-top:1px solid ;
  border-bottom:1px solid ;
}
.round-left{
  border-left:1px solid ;
  border-radius:12px 0 0 12px;
}
tbody td:last-child{
  border-right:1px solid ;
  border-radius:0 12px 12px 0;
}
.no-data{
  text-align:center;
  padding:16px 0;
}
tbody td.no-data{
  border-left:1px solid ;
  border-right:1px solid ;
  border-radius:12px;
}
.check-col{
  width:48px;
  text-align:center;
}
.sno{width:60px}
.name{
  width:220px;
  overflow-wrap:anywhere;
}
.doctor{
  width:200px;
  overflow-wrap:anywhere;
}
.amount{
  width:120px;
  text-align:right;
  font-weight:600;
  white-space:nowrap;
}
.status-col{
  width:140px;
  white-space:nowrap;
}
.status{
  font-weight:600;
}
.options{width:90px}
.menu{
  position:relative;
  display:inline-flex;
  justify-content:center;
  width:100%;
}
.menu-btn{
  cursor:pointer;
  font-size:18px;
  line-height:1;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid ;
}
.menu-list{
  display:none;
  position:absolute;
  right:0;
  top:32px;
  border-radius:14px;
  border:1px solid ;
  z-index:30;
  min-width:140px;
  overflow:hidden;
}
.menu-list div{
  padding:10px 16px;
  cursor:pointer;
  font-size:13px;
}
.menu-list div:hover{}
.menu-list .danger{}
.row-check{
  width:16px;
  height:16px;
  accent-
}
@keyframes fadeUp{
  from{opacity:0; transform:translateY(8px)}
  to{opacity:1; transform:translateY(0)}
}
@media (max-width:900px){
  body{padding:16px}
  .head-title{flex-direction:column; align-items:flex-start}
  .neo-btn{width:100%; justify-content:center}
  .filters{grid-template-columns:1fr}
}
@media (max-width:600px){
  .head-title h1{font-size:28px}
  .input-wrap{padding:10px}
}
</style>
  <link rel="stylesheet" href="theme.css">
</head>
<body>
<script src="theme-init.js"></script>
<div class="page">
  <div class="head-title">
    <div>
      <h1>Patients</h1>
      <div class="subtitle">Daily registrations and billing</div>
    </div>
    <button class="neo-btn" onclick="location.href='pt/new.html'">
      <i class="bx bx-plus"></i> New Patient
    </button>
  </div>
  <div class="filters">
    <div class="filter-group">
      <label for="datePicker">Date</label>
      <div class="input-wrap">
        <button class="icon-btn" type="button" id="dateToggle" aria-label="Open date">
          <i class="bx bx-calendar"></i>
        </button>
        <input type="date" id="datePicker" class="neo-input">
      </div>
    </div>
    <div class="filter-group">
      <label for="searchBox">Search</label>
      <div class="input-wrap">
        <button class="icon-btn" type="button" id="searchToggle" aria-label="Open search">
          <i class="bx bx-search"></i>
        </button>
        <input type="text" id="searchBox" class="neo-input"
               placeholder="Search patient..."
               onkeyup="searchPatient()">
      </div>
    </div>
  </div>
  <div class="bulk-bar" id="bulkBar">
    <div id="selectedCount">0 items selected</div>
    <div class="bulk-actions">
      <button class="neo-btn" onclick="deleteSelected()">Delete Selected</button>
      <button class="neo-btn secondary" onclick="exitSelectMode()">Cancel</button>
    </div>
  </div>
  <div class="table-box">
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th id="checkHead" class="check-col" style="display: none"></th>
          <th class="sno">S.No</th>
          <th class="name">Name</th>
          <th class="doctor">Doctor</th>
          <th class="amount">Amount</th>
          <th class="status-col">Status</th>
          <th class="options">Options</th>
        </tr>
        </thead>
        <tbody id="patientTable"></tbody>
      </table>
    </div>
  </div>
</div>
<script src="../../api.js"></script>
<script>
if(parent?.setActiveMenu){ parent.setActiveMenu("patient"); }
const datePicker = document.getElementById("datePicker");
const searchBox  = document.getElementById("searchBox");
const dateToggle = document.getElementById("dateToggle");
const searchToggle = document.getElementById("searchToggle");
const tableBody  = document.getElementById("patientTable");
const bulkBar    = document.getElementById("bulkBar");
const checkHead  = document.getElementById("checkHead");
const selectedCount = document.getElementById("selectedCount");
let allPatients = [];
let selectMode = false;
let isAutoDate = true;
function getLocalDateInputValue(date = new Date()) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}
datePicker.value = getLocalDateInputValue();
loadByDate(datePicker.value);
function setDateToToday(){
  const today = getLocalDateInputValue();
  if (datePicker.value !== today) {
    datePicker.value = today;
    loadByDate(today);
  }
}
function scheduleMidnightUpdate(){
  const now = new Date();
  const nextMidnight = new Date(now);
  nextMidnight.setHours(24, 0, 0, 0);
  const delay = Math.max(0, nextMidnight.getTime() - now.getTime() + 1000);
  setTimeout(() => {
    if (isAutoDate) {
      setDateToToday();
    }
    scheduleMidnightUpdate();
  }, delay);
}
datePicker.onchange = () => {
  isAutoDate = datePicker.value === getLocalDateInputValue();
  loadByDate(datePicker.value);
};
scheduleMidnightUpdate();
function loadByDate(date){
  fetch(`${API_BASE_URL}/patients/by-date/${date}`)
    .then(r=>r.json())
    .then(d=>{ allPatients=d; renderTable(d); })
    .catch(()=>renderEmpty());
}
function searchPatient(){
  const q = searchBox.value.toLowerCase();
  renderTable(allPatients.filter(p =>
    (p.name||"").toLowerCase().includes(q)
  ));
}
function openDatePicker(){
  datePicker.focus();
  if (typeof datePicker.showPicker === "function") {
    datePicker.showPicker();
  }
}
function focusSearch(){
  searchBox.focus();
}
dateToggle.addEventListener("click", openDatePicker);
searchToggle.addEventListener("click", focusSearch);
function renderTable(data){
  tableBody.innerHTML="";
  if(!data.length){ renderEmpty(); return; }
  const checkClass = selectMode ? "check-col round-left" : "check-col";
  const snoClass = selectMode ? "sno" : "sno round-left";
  data.forEach((p,i)=>{
    tableBody.innerHTML+=`
    <tr>
      <td class="${checkClass}" style="display: ${selectMode?'table-cell':'none'}">
        <input type="checkbox"
               id="patient-${p.id}"
               name="patient-${p.id}"
               class="row-check"
               data-id="${p.id}"
               onchange="updateCount()">
      </td>
      <td class="${snoClass}">${i+1}</td>
      <td class="name">${p.name || "-"}</td>
      <td class="doctor">${p.doctor||'-'}</td>
      <td class="amount">â‚¹${p.amount}</td>
      <td class="status-col"><span class="status">${p.status}</span></td>
      <td class="options">
        <div class="menu">
          <button class="menu-btn" type="button" onclick="toggleMenu(${p.id})">â‹®</button>
          <div class="menu-list" id="menu-${p.id}">
            <div onclick="enterSelectMode()">Select</div>
            <div onclick="editPatient(${p.id})">Edit</div>
            <div onclick='openBill(${JSON.stringify(p)})'>Bill</div>
            <div class="danger" onclick="deleteOne(${p.id})">Delete</div>
          </div>
        </div>
      </td>
    </tr>`;
  });
}
function renderEmpty(){
  tableBody.innerHTML=`<tr>
    <td colspan="7" class="no-data">
      No patients found
    </td></tr>`;
}
function closeMenus(){
  document.querySelectorAll(".menu-list")
    .forEach(m=>m.style.display="none");
  document.querySelectorAll("#patientTable tr.menu-open")
    .forEach(row => row.classList.remove("menu-open"));
  document.body.classList.remove("menu-open");
}
function toggleMenu(id){
  const m=document.getElementById(`menu-${id}`);
  const isOpen = m && m.style.display === "block";
  closeMenus();
  if (m) {
    m.style.display=isOpen?"none":"block";
    if (!isOpen) {
      const row = m.closest("tr");
      if (row) {
        row.classList.add("menu-open");
      }
      document.body.classList.add("menu-open");
    }
  }
}
document.addEventListener("click", (event) => {
  if (!event.target.closest(".menu")) {
    closeMenus();
  }
});
function enterSelectMode(){
  selectMode=true;
  bulkBar.style.display="flex";
  checkHead.style.display="table-cell";
  closeMenus();
  renderTable(allPatients);
}
function exitSelectMode(){
  selectMode=false;
  bulkBar.style.display="none";
  checkHead.style.display="none";
  closeMenus();
  renderTable(allPatients);
}
function updateCount(){
  const c=document.querySelectorAll(".row-check:checked").length;
  selectedCount.innerText=`${c} items selected`;
}
function deleteOne(id){
  if(!confirm("Delete patient and all related data?")) return;
  fetch(`${API_BASE_URL}/patients/${id}`, {
    method: "DELETE"
  })
  .then(() => {
    // ðŸ”¥ clear localStorage if this patient was open
    const current =
      JSON.parse(localStorage.getItem("currentPatient") || "{}");
    if(current.id === id){
      localStorage.removeItem("currentPatient");
      localStorage.removeItem("selectedTests");
      localStorage.removeItem("patientResults");
    }
    loadByDate(datePicker.value);
  })
  .catch(err => {
    console.error(err);
    alert("Failed to delete patient");
  });
}
function deleteSelected(){
  const checked = document.querySelectorAll(".row-check:checked");
  if(!checked.length){
    alert("No patients selected");
    return;
  }
  if(!confirm("Delete selected patients and all related data?")) return;
  const ids = [...checked].map(cb => Number(cb.dataset.id));
  Promise.all(
    ids.map(id =>
      fetch(`${API_BASE_URL}/patients/${id}`, {
        method: "DELETE"
      })
  .then(() => {
    // ðŸ”¥ clear localStorage if deleted patient was active
    const current =
      JSON.parse(localStorage.getItem("currentPatient") || "{}");
    if(ids.includes(current.id)){
      localStorage.removeItem("currentPatient");
      localStorage.removeItem("selectedTests");
      localStorage.removeItem("patientResults");
    }
    exitSelectMode();
    loadByDate(datePicker.value);
  })
  .catch(err => {
    console.error(err);
    alert("Bulk delete failed");
  });
}
function editPatient(id){
  alert("Edit coming soon");
}
function openBill(patient){
  if (!patient || !patient.id) {
    alert("Patient not found");
    return;
  }
  localStorage.setItem("currentPatient", JSON.stringify(patient));
  localStorage.removeItem("selectedTests");
  localStorage.removeItem("patientResults");
  if (parent?.loadPage) {
    parent.loadPage("home/sub-tasks/pt/bill.html", "patient");
  } else {
    location.href = "pt/bill.html";
  }
}
</script>
</body>
</html>